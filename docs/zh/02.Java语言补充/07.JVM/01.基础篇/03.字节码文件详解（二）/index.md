# ç¬¬ä¸€ç« ï¼šç±»çš„ç”Ÿå‘½å‘¨æœŸ

## 1.1 æ¦‚è¿°

* `ç±»çš„ç”Ÿå‘½å‘¨æœŸ`æè¿°çš„æ˜¯ä¸€ä¸ªç±»è¢«`åŠ è½½`ã€`ä½¿ç”¨`ã€ä»¥åŠ`å¸è½½`çš„æ•´ä¸ªè¿‡ç¨‹ã€‚

> [!NOTE]
>
> ä¸‹æ–‡ä¼šè¯¦ç»†åœ°æ‹†è§£ï¼Œåœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çš„æ¯ä¸ªé˜¶æ®µï¼Œè™šæ‹Ÿæœºåˆ°åº•åšäº†ä»€ä¹ˆäº‹æƒ…ï¼ï¼ï¼

## 1.2 ä¸ºä»€ä¹ˆè¦å­¦ä¹ ï¼Ÿ

* â‘  `ç±»çš„ç”Ÿå‘½å‘¨æœŸ`æœ¬èº«å°±æ˜¯ä¸€ä¸ª`é«˜é¢‘é¢è¯•é¢˜`ã€‚

```txt
ã€é—®ã€‘ç±»çš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºå“ªå‡ ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µåˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ
```

```txt
ã€é—®ã€‘æè¿°ä¸€ä¸‹ï¼Œè¿™ä¸ªç±»æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­çš„ï¼Ÿ
```

* â‘¡ `ç±»çš„ç”Ÿå‘½å‘¨æœŸ`ä¸­çš„`åˆå§‹åŒ–é˜¶æ®µ`é¢‘ç¹å‡ºç°åœ¨`å¤§å‚ç¬”è¯•é¢˜`ä¸­ã€‚

::: code-group

```java [Test1.java]
public class Test1 {

    static  {
        System.out.println("D");
    }

    {
        System.out.println("C");
    }

    public Test1(){
        System.out.println("B");
    }

    public static void main(String[] args){
        System.out.println("A");

        new Test1();
        new Test1();
    }
}
```

```java [Test2.java]
public class Test2 {
    public static void main(String[] args) {
        new B02();
        System.out.println(B02.a);
    }
}

class A02 {
    static int a = 0;

    static {
        a = 1;
    }
}

class B02 extends A02 {
    static {
        a = 2;
    }
}
```

:::

* â‘¢ `ç±»çš„ç”Ÿå‘½å‘¨æœŸ`ç›¸å…³çŸ¥è¯†ç‚¹æ˜¯åç»­å¤§é‡çŸ¥è¯†ç‚¹çš„`åŸºç¡€çŸ¥è¯†`ã€‚

> [!NOTE]
>
> * :one:è¿è¡Œæ—¶å¸¸é‡æ± ã€‚â€‹ 
> * :two: ç±»åŠ è½½å™¨çš„ä½œç”¨ã€‚
> * :three: å¤šæ€çš„åŸç†ã€‚
> * :four: ç±»çš„åŠ å¯†å’Œè§£å¯†ã€‚

## 1.3 ç±»çš„ç”Ÿå‘½å‘¨æœŸçš„ä¸»è¦é˜¶æ®µ

* `ç±»çš„ç”Ÿå‘½å‘¨æœŸ`çš„ä¸»è¦é˜¶æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

> [!NOTE]
>
> * â‘  ä½¿ç”¨é˜¶æ®µï¼šæ˜¯æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„é˜¶æ®µï¼Œå› ä¸ºå¹³å¸¸ç»å¸¸ä½¿ç”¨çš„ã€‚
>
> ```java
> Test test = new Test();
> 
> Class<Test> clazz = test.class;
> Test test2 = clazz.newInstance();
> ```
>
> * â‘¡ å¸è½½é˜¶æ®µï¼šæš‚æ—¶ä¸ä¼šæ¶‰åŠï¼Œå°†ä¼šåœ¨åƒåœ¾å›æ”¶ç¯‡ä¸­è®²è§£ã€‚

![](./assets/58.svg)

* `ç±»çš„ç”Ÿå‘½å‘¨æœŸ`ä¸»è¦é˜¶æ®µçš„è¯¦ç»†å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| ç±»çš„ç”Ÿå‘½å‘¨æœŸä¸»è¦é˜¶æ®µ       | æè¿°                                                         |
| -------------------------- | ------------------------------------------------------------ |
| â‘  åŠ è½½ï¼ˆLoadingï¼‰          | ç±»çš„å­—èŠ‚ç æˆ–å®šä¹‰è¢«è¯»å…¥å†…å­˜ï¼Œä½†è¿˜æœªè¿›è¡Œåˆå§‹åŒ–ã€‚<br>è¿™é€šå¸¸å‘ç”Ÿåœ¨ç¨‹åºé¦–æ¬¡å¼•ç”¨è¯¥ç±»æ—¶ã€‚ |
| â‘¡ é“¾æ¥ï¼ˆLinkingï¼‰          | éªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰å’Œè§£æï¼ˆResolutionï¼‰ã€‚<br>åŒ…æ‹¬éªŒè¯ç±»çš„ç»“æ„å®Œæ•´æ€§ã€ä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œä»¥åŠè§£æç±»ä¸­çš„ç¬¦å·å¼•ç”¨ã€‚ |
| â‘¢ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ | æ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–ä»£ç ï¼Œå¦‚ï¼šé™æ€å˜é‡èµ‹å€¼ã€é™æ€ä»£ç å—ç­‰ã€‚<br/>è¿™ä¸ªé˜¶æ®µç¡®ä¿ç±»åœ¨é¦–æ¬¡ä½¿ç”¨å‰å¤„äºæ­£ç¡®çŠ¶æ€ã€‚ |
| â‘£ ä½¿ç”¨ï¼ˆUsingï¼‰            | ç±»è¢«å®ä¾‹åŒ–åˆ›å»ºå¯¹è±¡ï¼Œæˆ–è€…ç›´æ¥è®¿é—®é™æ€æˆå‘˜ã€‚<br/>è¿™æ˜¯ç±»å‘æŒ¥å®é™…ä½œç”¨çš„é˜¶æ®µã€‚ |
| â‘¤ å¸è½½ï¼ˆUnloadingï¼‰        | å½“ç±»ä¸å†è¢«å¼•ç”¨ä¸”æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å¯èƒ½ä¼šå¸è½½è¯¥ç±»ï¼Œé‡Šæ”¾ç›¸å…³å†…å­˜ã€‚ |

* åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬æš‚æ—¶åªä¼šèšç„¦`ç±»çš„ç”Ÿå‘½å‘¨æœŸ`çš„å‰ä¸‰ä¸ªé˜¶æ®µï¼š`åŠ è½½`ã€`é“¾æ¥`ä»¥åŠ`åˆå§‹åŒ–`ã€‚

> [!NOTE]
>
> * â‘  `åŠ è½½`ã€`é“¾æ¥`ä»¥åŠ`åˆå§‹åŒ–`ä¸­æœ€é‡è¦çš„æ˜¯`åˆå§‹åŒ–`é˜¶æ®µã€‚
> * â‘¡ ä¹‹æ‰€ä»¥`åˆå§‹åŒ–`é˜¶æ®µæœ€é‡è¦ï¼Œæ˜¯å› ä¸ºç¨‹åºå‘˜å¯ä»¥å¹²æ¶‰ï¼Œå¹¶ä¸”åœ¨ç¬”è¯•é¢˜ä¸­ä¼šå¤§é‡æ¶‰åŠåˆ°ã€‚

## 1.4 åŠ è½½é˜¶æ®µ

### 1.4.1 æ­¥éª¤

* â‘  `ç±»åŠ è½½å™¨`æ ¹æ®ç±»çš„`å…¨é™å®šå`é€šè¿‡`ä¸åŒçš„æ¸ é“`ä»¥äºŒè¿›åˆ¶æµçš„æ–¹å¼å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

> [!NOTE]
>
> ::: details ç‚¹æˆ‘æŸ¥çœ‹ ä¸åŒçš„æ¸ é“
>
> * â‘  ä»æœ¬åœ°ç£ç›˜ä¸Šè·å–æ–‡ä»¶ï¼šè¿™æ˜¯æœ€å¸¸è§çš„æ–¹å¼ã€‚
>
> ```java
> package com.example;
> // ä¼ ç»Ÿçš„ .class æ–‡ä»¶åŠ è½½
> // ç±»åŠ è½½å™¨ä¼šåœ¨ classpath ä¸­æŸ¥æ‰¾ com/example/MyClass.class
> public class MyClass {
>     // ç±»å®šä¹‰
> }
> ```
>
> * â‘¡ è¿è¡Œæ—¶åŠ¨æ€ä»£ç†ç”Ÿæˆï¼šSpring æ¡†æ¶ä¸­å°±å¤§é‡ä½¿ç”¨è¯¥æŠ€æœ¯ã€‚
>
> ```java
> // Spring AOP ä»£ç†ç¤ºä¾‹
> // Spring ä¼šä¸ºè¿™ä¸ªç±»ç”Ÿæˆä»£ç†
> @Service
> public class UserService {
> 
>     @Transactional
>     public void saveUser(User user) {
>         // ä¸šåŠ¡é€»è¾‘
>     }
> }
> ```
>
> ```java
> // Spring å†…éƒ¨ä¼šåŠ¨æ€ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ä»£ç†ç±»å­—èŠ‚ç 
> public class UserService$$EnhancerBySpringCGLIB extends UserService {
> 	// å¢å¼ºåçš„æ–¹æ³•å®ç°
> }
> ```
>
> * â‘¢ é€šè¿‡ç½‘ç»œè·å–å­—èŠ‚ç æ–‡ä»¶ï¼Œå¦‚ï¼šApplet æŠ€æœ¯ï¼ˆå·²æ·˜æ±°ï¼‰ã€‚
>
> ```html
> <!-- HTML ä¸­çš„ applet æ ‡ç­¾ -->
> <applet code="MyApplet.class" 
>         codebase="http://example.com/applets/"
>         width="300" height="200">
> </applet>
> ```
>
> * â‘£ ç¨‹åºå‘˜å¯ä»¥è‡ªå®šä¹‰æ‰©å±•æ–¹å¼ï¼šæˆ‘ä»¬å¯ä»¥ç»§æ‰¿ classLoader å®ç°è‡ªå®šä¹‰åŠ è½½ã€‚
>
> ```java
> public class CustomClassLoader extends ClassLoader {
>     
>     @Override
>     protected Class<?> findClass(String name) throws ClassNotFoundException {
>         try {
>             // å¯ä»¥ä»ä»»ä½•åœ°æ–¹è·å–å­—èŠ‚ç 
>             byte[] classData = getClassDataFromCustomSource(name);
> 
>             // å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º Class å¯¹è±¡
>             return defineClass(name, classData, 0, classData.length);
>         } catch (Exception e) {
>             throw new ClassNotFoundException(name);
>         }
>     }
> 
>     private byte[] getClassDataFromCustomSource(String className) {
>         // è¿™é‡Œå¯ä»¥å®ç°å„ç§è·å–å­—èŠ‚ç çš„æ–¹å¼ï¼š
>         // 1. ä»æ•°æ®åº“è¯»å–
>         // 2. ä»åŠ å¯†æ–‡ä»¶è§£å¯†è·å–
>         // 3. é€šè¿‡ HTTP è¯·æ±‚è·å–
>         // 4. ä»å†…å­˜ä¸­çš„å­—èŠ‚æ•°ç»„è·å–
>         return new byte[0]; 
>     }
> }
> ```
>
> :::

* â‘¡ ç±»åŠ è½½å™¨åœ¨åŠ è½½å®Œç±»ä¹‹åï¼ŒJVM ä¼šå°†å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°æ–¹æ³•åŒºä¸­ï¼Œ`å¹¶åœ¨æ–¹æ³•åŒºä¸­ä¼šç”Ÿæˆä¸€ä¸ª InstanceKlass å¯¹è±¡ï¼Œä¿å­˜äº†ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œé‡Œé¢è¿˜åŒ…å«äº†ç‰¹å®šåŠŸèƒ½ï¼Œå¦‚ï¼šå¤šæ€çš„ä¿¡æ¯`ã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœ JVM éœ€è¦åˆ›å»ºè¿™ä¸ªç±»å¯¹åº”çš„å¯¹è±¡ï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™äº›ä¿¡æ¯ã€‚

> [!NOTE]
>
> ::: details ç‚¹æˆ‘æŸ¥çœ‹ æ–¹æ³•åŒº
>
> * â‘  æ–¹æ³•åŒºåªæ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­è®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªè™šæ‹Ÿæ¦‚å¿µã€‚
> * â‘¡ ä¸åŒç§ç±»çš„ Java è™šæ‹Ÿæœºï¼Œç”šè‡³ä¸åŒç‰ˆæœ¬çš„ Hotspot è™šæ‹Ÿæœºï¼Œåœ¨è®¾è®¡æ–¹æ³•åŒºçš„æ—¶å€™ï¼Œéƒ½ç”¨åˆ°äº†ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œå¦‚ï¼šJDK7 ä¹‹å‰ä½¿ç”¨åˆ°çš„æ˜¯æ°¸ä¹…ä»£ï¼Œè€Œ JDK8 ä¹‹åä½¿ç”¨çš„æ˜¯å…ƒç©ºé—´ã€‚
> * â‘¢ æ–¹æ³•åŒºåªæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µï¼ŒçœŸæ­£çš„å®ç°ï¼Œåœ¨åç»­çš„æ–‡ç« ä¸­ä¼šæœ‰è¯¦ç»†è®²è§£ï¼ï¼ï¼
>
> :::

![](./assets/59.svg)

* â‘¢ JVM è¿˜ä¼šåœ¨å †ä¸­ç”Ÿæˆä¸€ä»½å’Œæ–¹æ³•åŒºä¸­æ•°æ®ç±»ä¼¼çš„ `java.lang.Class` å¯¹è±¡ï¼Œå…¶ä½œç”¨æ˜¯`å¯ä»¥åœ¨ Java ä»£ç ä¸­è·å–ç±»çš„ä¿¡æ¯ä»¥åŠå­˜å‚¨çš„é™æ€å­—æ®µçš„æ•°æ®`ï¼ˆJDK8+ï¼‰ã€‚

![](./assets/60.svg)

### 1.4.2 ç–‘é—®ï¼Ÿ

* åœ¨åŠ è½½é˜¶æ®µï¼Œæ˜¯é€šè¿‡ç±»åŠ è½½å™¨å°†å­—èŠ‚ç æ–‡ä»¶çš„ä¿¡æ¯åŠ è½½åˆ°å†…å­˜ä¸­ï¼ŒJVM ä¼šåœ¨æ–¹æ³•åŒºå’Œå †åŒºä¸­åˆ†åˆ«åˆ›å»ºä¸€ä»½å¯¹è±¡ï¼Œä»¥ä¾¿åé¢ä½¿ç”¨ã€‚

![](./assets/60.svg)

* é‚£ä¹ˆï¼Œèƒ½å¦åªåœ¨æ–¹æ³•åŒºä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œä»¥ä¾¿èŠ‚çœå†…å­˜ç©ºé—´ï¼Ÿ

![](./assets/59.svg)

* `ä¸å¯ä»¥`ï¼Œå…¶ä¸­ä¸€ç‚¹åŸå› æ˜¯ InstanceKlass å¯¹è±¡æ˜¯é€šè¿‡ C++ è¯­è¨€æ¥åˆ›å»ºçš„ï¼Œè€Œ Java è¯­è¨€ä¸€èˆ¬æ˜¯ä¸èƒ½ç›´æ¥å»æ“ä½œ C++ è¯­è¨€ç¼–å†™çš„å¯¹è±¡ï¼ˆé™¤éé‡‡ç”¨ JNI æˆ– JNA ç­‰ï¼Œä½†æ˜¯éå¸¸éº»çƒ¦ï¼‰ï¼›æ‰€ä»¥ï¼ŒJVM å°±åœ¨å †ä¸Šåˆ›å»ºäº† java.lang.Class å¯¹è±¡ï¼Œä»¥ä¾¿ Java è¯­è¨€è®¿é—®ã€‚

![](./assets/62.png)

* `ä¸å¯ä»¥`ï¼Œå¦å¤–ä¸€ç‚¹åŸå› æ˜¯å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œåªéœ€è¦è®¿é—®å †ä¸­çš„ class å¯¹è±¡è€Œä¸éœ€è¦è®¿é—®æ–¹æ³•åŒºä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå³ï¼š`JVM å°±å¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶å¼€å‘è€…è®¿é—®æ•°æ®çš„èŒƒå›´`ã€‚

![](./assets/61.svg)

### 1.4.3 æŸ¥çœ‹å†…å­˜ä¸­çš„å¯¹è±¡

* å¯ä»¥ä½¿ç”¨ JDK è‡ªå¸¦çš„ `hsdb` ï¼ˆHotSpot Debuggerï¼‰å·¥å…·æ¥æŸ¥çœ‹ JVM å†…å­˜çš„è¯¦ç»†ä¿¡æ¯ã€‚

> [!NOTE]
>
> * â‘  hsdb æ˜¯ HotSpot è™šæ‹Ÿæœºçš„è°ƒè¯•å™¨ï¼Œå¯ä»¥æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ JVM è¿›ç¨‹æˆ– core dump æ–‡ä»¶çš„å†…å­˜çŠ¶æ€ã€‚
> * â‘¡ JDK8 ä¹‹å‰å¯åŠ¨ hsdb ï¼ˆç›®å‰ä½¿ç”¨çš„ç‰ˆæœ¬ï¼‰ï¼š
>
> ```shell
> java -cp $JAVA_HOME/lib/sa-jdi.jar sun.jvm.hotspot.HSDB
> ```
>
> * â‘¡ JDK9 ä¹‹åå¯åŠ¨ hsdbï¼š
>
> ```shell
> jhsdb hsdb
> ```

* :one: å‡†å¤‡ä»£ç ï¼Œå¹¶ç¼–è¯‘å’Œå¯åŠ¨ï¼š

::: code-group

```java [HsdbDemo.java]
import java.io.IOException;

public class HsdbDemo {
    public static final int i = 10;
    public static void main(String[] args) throws IOException {
        new HsdbDemo();
        System.in.read();
    }
}
```

```bash
javac HsdbDemo.java
java HsdbDemo
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/63.gif)
```

:::

* :two: æŸ¥çœ‹å½“å‰è¿è¡Œçš„ Java è¿›ç¨‹çš„ pid ï¼š

::: code-group

```bash
jps
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/64.gif)
```

:::

* :three: å¯åŠ¨ hsdb çš„å›¾å½¢åŒ–ç•Œé¢ï¼š

::: code-group

```bash
java -cp $JAVA_HOME/lib/sa-jdi.jar sun.jvm.hotspot.HSDB
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/65.gif)
```

:::

* :four: é€‰æ‹© `File` --> `Attach to Hotspot process`ï¼Œå¹¶è¾“å…¥æŒ‡å®šçš„ Java è¿›ç¨‹ pid ï¼š

![](./assets/66.gif)

* :five: é€‰æ‹© `Tools` --> `Object Histogram`ï¼Œå¹¶è¾“å…¥ `HsdbDemo`ï¼Œä»¥ä¾¿æ‰¾åˆ°å¯¹åº”çš„ Java å¯¹è±¡ï¼š

![](./assets/67.gif)

* :six: é¼ æ ‡åŒå‡»è¿›å»ï¼Œå¹¶ç‚¹å‡» `Inspect` æŒ‰é’®ï¼š

![](./assets/68.gif)

## 1.5 é“¾æ¥é˜¶æ®µ

### 1.5.1 æ¦‚è¿°

* `é“¾æ¥`ï¼ˆLinkingï¼‰é˜¶æ®µåˆ†ä¸ºä¸‰ä¸ªå°é˜¶æ®µï¼š

| é“¾æ¥é˜¶æ®µçš„å­é˜¶æ®µ         | æè¿°                                                         |
| ------------------------ | ------------------------------------------------------------ |
| â‘  `éªŒè¯`ï¼ˆVerificationï¼‰ | éªŒè¯å†…å®¹æ˜¯å¦æ»¡è¶³ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ï¼Œç¡®ä¿ä¸ä¼šå±å®³è™šæ‹Ÿæœºå®‰å…¨ã€‚ |
| â‘¡ ` å‡†å¤‡`ï¼ˆPreparationï¼‰ | ç»™é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶èµ‹åˆå§‹åŒ–å€¼ã€‚                           |
| â‘¢ `è§£æ`ï¼ˆResolutionï¼‰   | å°†å¸¸é‡æ± ä¸­çš„`ç¬¦å·å¼•ç”¨`æ›¿æ¢æˆæ‰§è¡Œå†…å­˜çš„`ç›´æ¥å¼•ç”¨`ã€‚           |

> [!NOTE]
>
> ä¸Šè¿°é“¾æ¥çš„ä¸‰ä¸ªå­é˜¶æ®µï¼Œå°±æ˜¯åšäº†ä¸€äº›æ ¡éªŒå’Œå‰æœŸçš„å‡†å¤‡å·¥ä½œï¼Œå¹¶ä¸ä¼šæ‰§è¡Œç¨‹åºå‘˜å†™çš„ä»£ç ã€‚

### 1.5.2 éªŒè¯

#### 1.5.2.1 æ¦‚è¿°

* `éªŒè¯`çš„ä¸»è¦ç›®çš„æ˜¯`æ£€æµ‹ Java å­—èŠ‚ç æ–‡ä»¶æ˜¯å¦æ»¡è¶³ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­çš„çº¦æŸ`ã€‚

> [!NOTE]
>
> è¿™ä¸ªé˜¶æ®µä¸éœ€è¦ç¨‹åºå‘˜çš„å‚ä¸ï¼ï¼ï¼

* ä¸»è¦åŒ…å«å››ä¸ªæ–¹é¢çš„å†…å®¹ï¼š

| éªŒè¯çš„ä¸»è¦å†…å®¹           | æè¿°                                                         |
| ------------------------ | ------------------------------------------------------------ |
| â‘  æ–‡ä»¶æ ¼å¼éªŒè¯           | æ–‡ä»¶æ˜¯å¦ä»¥ 0xCAFEBABE å¼€å¤´ã€‚<br>ä¸»æ¬¡ç‰ˆæœ¬å·æ˜¯å¦æ»¡è¶³å½“å‰ JVM ç‰ˆæœ¬è¦æ±‚ã€‚ |
| â‘¡ å…ƒæ•°æ®éªŒè¯             | æ£€æŸ¥ç±»çš„ç»“æ„ä¿¡æ¯æ˜¯å¦ç¬¦åˆ Java è¯­è¨€è§„èŒƒï¼Œç¡®ä¿ç±»çš„å®šä¹‰æ˜¯åˆæ³•çš„ã€‚ |
| â‘¢ ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤çš„è¯­ä¹‰éªŒè¯ | ç¡®ä¿å­—èŠ‚ç æŒ‡ä»¤çš„è¯­ä¹‰æ˜¯åˆæ³•çš„ã€ç¬¦åˆé€»è¾‘ã€‚                     |
| â‘£ ç¬¦å·å¼•ç”¨éªŒè¯           | å¯¹ç±»è‡ªèº«ä»¥å¤–ï¼ˆå¸¸é‡æ± ä¸­çš„å„ç§ç¬¦å·å¼•ç”¨ï¼‰çš„ä¿¡æ¯è¿›è¡ŒåŒ¹é…æ€§æ ¡éªŒã€‚ |

#### 1.5.2.2 æ–‡ä»¶æ ¼å¼éªŒè¯

* `æ–‡ä»¶æ ¼å¼éªŒè¯`ä¸»è¦ç¡®ä¿è¾“å…¥çš„å­—èŠ‚æµèƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ã€‚

| éªŒè¯é˜¶æ®µ     | æè¿°                                  |
| ------------ | ------------------------------------- |
| æ–‡ä»¶æ ¼å¼æ ¡éªŒ | æ–‡ä»¶æ˜¯å¦ä»¥ 0xCAFEBABE å¼€å¤´ã€‚          |
| ^^           | ä¸»æ¬¡ç‰ˆæœ¬å·æ˜¯å¦æ»¡è¶³å½“å‰ JVM ç‰ˆæœ¬è¦æ±‚ã€‚ |
| ^^           | ...                                   |



* ç¤ºä¾‹ï¼šä¿®æ”¹é­”æ•°ï¼Œçœ‹æ˜¯å¦èƒ½å¯åŠ¨

::: code-group

```java [Test.java]
import java.io.IOException;

public class Test {
    public static final int i = 10;

    public static void main(String[] args) throws IOException {
        System.out.println("Hello World!!!");
    }
}
```

```md:img [IDEAç¼–è¯‘å’Œè¿è¡Œ]
![](./assets/69.gif)
```

```md:img [cmd æ§åˆ¶å°(ä¿®æ”¹é­”æ•°)]
![](./assets/70.gif)
```

```md:img [IDEAè¿è¡Œ]
![](./assets/71.gif)
```

:::



* ç¤ºä¾‹ï¼šä¸»æ¬¡ç‰ˆæœ¬å·æ˜¯å¦æ»¡è¶³å½“å‰ JVM ç‰ˆæœ¬è¦æ±‚

```cpp
bool ClassFileParser::is_supported_version(u2 major, u2 minor) {
  u2 max_version =
    JDK_Version::is_gte_jdk17x_version() ? JAVA_MAX_SUPPORTED_VERSION :
    (JDK_Version::is_gte_jdk16x_version() ? JAVA_6_VERSION : JAVA_1_5_VERSION);
  // ç¼–è¯‘æ–‡ä»¶çš„ä¸»ç‰ˆæœ¬å·ä¸èƒ½é«˜äºè¿è¡Œç¯å¢ƒçš„ä¸»ç‰ˆæœ¬å·
  // å¦‚æœä¸»ç‰ˆæœ¬å·ç›¸ç­‰ï¼Œæ¬¡ç‰ˆæœ¬å·ä¹Ÿä¸èƒ½è¶…è¿‡  
  return (major >= JAVA_MIN_SUPPORTED_VERSION) &&
         (major <= max_version) &&
         ((major != max_version) ||
          (minor <= JAVA_MAX_SUPPORTED_MINOR_VERSION));
}
```

#### 1.5.2.3 å…ƒæ•°æ®éªŒè¯

* `å…ƒæ•°æ®éªŒè¯`ä¸»è¦æ£€æŸ¥ç±»çš„ç»“æ„ä¿¡æ¯æ˜¯å¦ç¬¦åˆ Java è¯­è¨€è§„èŒƒï¼Œç¡®ä¿ç±»çš„å®šä¹‰æ˜¯åˆæ³•çš„ã€‚

| éªŒè¯é˜¶æ®µ   | æè¿°                               |
| ---------- | ---------------------------------- |
| å…ƒæ•°æ®éªŒè¯ | ç±»å¿…é¡»æœ‰çˆ¶ç±»ï¼Œå³ï¼šsuper ä¸èƒ½ä¸ºç©ºã€‚ |
| ^^         | ...                                |



* ç¤ºä¾‹ï¼š

::: code-group

```java [Test.java]
import java.io.IOException;

public class Test {
    public static final int i = 10;

    public static void main(String[] args) throws IOException {
        System.out.println("Hello World!!!");
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/72.png)
```

:::



#### 1.5.2.4 ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤çš„è¯­ä¹‰éªŒè¯

* `ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤çš„è¯­ä¹‰éªŒè¯`å¿…é¡»ç¡®ä¿ç¡®ä¿å­—èŠ‚ç æŒ‡ä»¤çš„è¯­ä¹‰æ˜¯åˆæ³•çš„ã€ç¬¦åˆé€»è¾‘çš„ã€‚

| éªŒè¯é˜¶æ®µ               | æè¿°                                   |
| ---------------------- | -------------------------------------- |
| ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤çš„è¯­ä¹‰éªŒè¯ | æ–¹æ³•å†…çš„æŒ‡ä»¤æ‰§è¡Œä¸­è·³è½¬åˆ°ä¸æ­£ç¡®çš„ä½ç½®ã€‚ |
| ^^                     | ...                                    |



* ç¤ºä¾‹ï¼š

::: code-group

```java [Test.java]
import java.io.IOException;

public class Test {
    public static final int i = 10;

    public static void main(String[] args) throws IOException {
        for (int i1 = 0; i1 < 10; i1++) {
            System.out.println("HelloWorld" + i1);
        }
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/73.png)
```

:::

#### 1.5.2.5 ç¬¦å·å¼•ç”¨éªŒè¯

* `ç¬¦å·å¼•ç”¨éªŒè¯`æ˜¯éªŒè¯é˜¶æ®µçš„æœ€åä¸€æ­¥ï¼Œå‘ç”Ÿåœ¨è™šæ‹Ÿæœºå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„æ—¶å€™ã€‚
* è¿™ä¸ªéªŒè¯å¯ä»¥çœ‹ä½œæ˜¯å¯¹ç±»è‡ªèº«ä»¥å¤–ï¼ˆå¸¸é‡æ± ä¸­çš„å„ç§ç¬¦å·å¼•ç”¨ï¼‰çš„ä¿¡æ¯è¿›è¡ŒåŒ¹é…æ€§æ ¡éªŒã€‚

| éªŒè¯é˜¶æ®µ     | æè¿°                                |
| ------------ | ----------------------------------- |
| ç¬¦å·å¼•ç”¨éªŒè¯ | æ˜¯å¦è®¿é—®äº†å…¶ä»–ç±»ä¸­ private çš„æ–¹æ³•ã€‚ |
| ^^           | ...                                 |



* ç¤ºä¾‹ï¼š

::: code-group

```java [Test.java]
package com.github.thread.demo10;

import java.io.IOException;

public class Test {
    public static final int i = 10;

    public static void main(String[] args) throws IOException {
        // ç¬¦å·å¼•ç”¨éªŒè¯ï¼šå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„æ—¶å€™
        String str = "hello";

        // é˜»å¡ï¼Œé˜²æ­¢è¿è¡Œç»“æŸ
        System.in.read();
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/74.png)
```

:::

### 1.5.3 å‡†å¤‡

#### 1.5.3.1 æ¦‚è¿°

* `å‡†å¤‡`é˜¶æ®µå°±æ˜¯ä¸º`é™æ€å˜é‡`ï¼ˆstaticï¼‰`åˆ†é…å†…å­˜`å¹¶`è®¾ç½®åˆå§‹å€¼`ã€‚

![åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šå°† count ä¿®æ”¹ä¸º 10](./assets/78.svg)

* æ¯ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹éƒ½æœ‰å…¶å¯¹åº”çš„åˆå§‹åŒ–å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| **æ•°æ®ç±»å‹**   | **åˆå§‹å€¼** |
| -------------- | ---------- |
| `int`          | `0`        |
| `long`         | `0L`       |
| `short`        | `0`        |
| `char`         | `'\u0000'` |
| `byte`         | `0`        |
| `boolean`      | `false`    |
| `double`       | `0.0`      |
| `å¼•ç”¨æ•°æ®ç±»å‹` | `null`     |

#### 1.5.3.2 åŸå› 

* åœ¨`å‡†å¤‡é˜¶æ®µ`ä¸ºé™æ€å˜é‡èµ‹å€¼åˆå§‹åŒ–å€¼ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯`å†…å­˜å®‰å…¨`ä»¥åŠ`ç¨‹åºçš„ç¡®å®šæ€§`ã€‚

> [!NOTE]
>
> ::: details ç‚¹æˆ‘æŸ¥çœ‹ å…·ä½“åŸå› 
>
> * â‘  `é¿å…æœªå®šä¹‰è¡Œä¸º`ï¼šå¦‚æœé™æ€å˜é‡åœ¨å†…å­˜ä¸­åŒ…å«éšæœºçš„åƒåœ¾æ•°æ®ï¼Œç¨‹åºåœ¨é¦–æ¬¡è®¿é—®è¿™äº›å˜é‡æ—¶å¯èƒ½ä¼šäº§ç”Ÿä¸å¯é¢„æµ‹çš„ç»“æœï¼Œå¯¼è‡´ç¨‹åºè¡Œä¸ºä¸ç¡®å®šã€‚
> * â‘¡ `æä¾›é»˜è®¤çš„å®‰å…¨çŠ¶æ€`ï¼šé€šè¿‡èµ‹äºˆé›¶å€¼ï¼ˆå¯¹äºæ•°å€¼ç±»å‹ä¸º 0ï¼Œå¯¹äºå¼•ç”¨ç±»å‹ä¸º nullï¼‰ï¼Œç¡®ä¿å˜é‡æœ‰ä¸€ä¸ªæ˜ç¡®çš„åˆå§‹çŠ¶æ€ï¼Œå³ä½¿å¼€å‘è€…æ²¡æœ‰æ˜¾å¼åˆå§‹åŒ–ã€‚
> * â‘¢ `ä¿è¯çº¿ç¨‹å®‰å…¨`ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚æœå˜é‡æ²¡æœ‰åˆå§‹åŒ–å°±è¢«è®¿é—®ï¼Œå¯èƒ½ä¼šå‡ºç°ç«æ€æ¡ä»¶ã€‚ç»Ÿä¸€çš„é›¶å€¼åˆå§‹åŒ–é¿å…äº†è¿™ç§æƒ…å†µã€‚
> * â‘£ `ç®€åŒ– JVM å®ç°`ï¼šJVM å¯ä»¥æ‰¹é‡å°†æ•´å—å†…å­˜åŒºåŸŸæ¸…é›¶ï¼Œè¿™æ¯”é€ä¸ªæ£€æŸ¥æ¯ä¸ªå˜é‡æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ›´é«˜æ•ˆã€‚
> * â‘¤ `ç¬¦åˆ Java è¯­è¨€è§„èŒƒ`ï¼šJava è§„èŒƒè¦æ±‚æ‰€æœ‰å­—æ®µéƒ½å¿…é¡»æœ‰ç¡®å®šçš„åˆå§‹å€¼ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç¨‹åºçš„å¯ç§»æ¤æ€§å’Œä¸€è‡´æ€§ã€‚
>
> :::

* è¿™ç§è®¾è®¡è®©ç¨‹åºå‘˜å¯ä»¥ä¾èµ–å˜é‡çš„é»˜è®¤åˆå§‹çŠ¶æ€ï¼Œå‡å°‘äº†å› å¿˜è®°åˆå§‹åŒ–è€Œå¯¼è‡´çš„ bug ï¼ŒåŒæ—¶ä¹Ÿè®© JVM çš„è¡Œä¸ºæ›´åŠ å¯é¢„æµ‹å’Œå®‰å…¨ã€‚



* ç¤ºä¾‹ï¼š

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {
    /**
     * é™æ€å˜é‡ä¼šåœ¨å‡†å¤‡é˜¶æ®µèµ‹åˆå§‹åŒ–å€¼
     */
    public static int count;

    public static void main(String[] args) {

        System.out.println("count = " + count);
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/79.gif)
```

:::

#### 1.5.3.3 æ³¨æ„äº‹é¡¹

* å¦‚æœä½¿ç”¨ final ä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ï¼ŒJVM åœ¨å‡†å¤‡é˜¶æ®µä¸ºè¿™ç±»å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œè·³è¿‡äº†åˆå§‹åŒ–é˜¶æ®µã€‚

> [!NOTE]
>
> ::: details ç‚¹æˆ‘æŸ¥çœ‹ å…·ä½“åŸå› 
>
> * â‘  `ç¼–è¯‘æ—¶å¸¸é‡`ï¼šå¯¹äº static final ä¿®é¥°çš„é™æ€å˜é‡ï¼Œå…¶å®åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†å€¼ï¼ˆåœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­å°±æŒæœ‰ä¸€ä¸ªå¸¸é‡æ± çš„å¼•ç”¨ï¼‰ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ä¼šå°†å…¶å½“åšå¸¸é‡æ¥å¤„ç†ã€‚
> * â‘¡ `é¿å…é‡å¤èµ‹å€¼`ï¼šç”±äºå€¼åœ¨ç¼–è¯‘æ—¶å·²çŸ¥ä¸”ä¸å¯å˜ï¼ŒJVM å¯ä»¥è·³è¿‡åˆå§‹åŒ–é˜¶æ®µçš„èµ‹å€¼æ“ä½œï¼Œæé«˜æ•ˆç‡ã€‚
>
> :::

![](./assets/80.svg)



* ç¤ºä¾‹ï¼š

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {
    /**
     * static final ä¿®é¥°çš„é™æ€å˜é‡ä¼šå½“åšç¼–è¯‘æ—¶å¸¸é‡ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µç›´æ¥å¤åˆ¶
     */
    public static final int count = 2;

    public static void main(String[] args) {

        System.out.println("count = " + count);
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/81.gif)
```

:::

### 1.5.4 è§£æ

* `ç¬¦å·å¼•ç”¨`å°±æ˜¯åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­ä½¿ç”¨`ç¼–å·`æ¥è®¿é—®å¸¸é‡æ± ä¸­çš„å†…å®¹ã€‚

![](./assets/82.png)

* `è§£æ`é˜¶æ®µä¸»è¦æ˜¯å°†å¸¸é‡æ± ä¸­çš„`ç¬¦å·å¼•ç”¨`æ›¿æ¢ä¸º`ç›´æ¥å¼•ç”¨`ã€‚

> [!NOTE]
>
> ä¸ä½¿ç”¨ç¼–å·ï¼Œè€Œæ˜¯ä½¿ç”¨å†…å­˜åœ°å€æ¥è¿›è¡Œå…·ä½“æ•°æ®çš„è®¿é—®ï¼Œå°±æ˜¯ä¸ºäº†æ€§èƒ½ï¼ˆåç»­å¯ä»¥ç›´æ¥é€šè¿‡å†…å­˜åœ°å€ä»å†…å­˜ä¸­è·å–æ•°æ®ï¼‰ã€‚

![ç›´æ¥å¼•ç”¨](./assets/83.gif)

## 1.6 åˆå§‹åŒ–é˜¶æ®µï¼ˆâ­ï¼‰

### 1.6.1 æ¦‚è¿°

* ä¹‹å‰è¯´è¿‡ï¼Œåœ¨`å‡†å¤‡é˜¶æ®µ`ä¼šä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œè®¾ç½®åˆå§‹åŒ–å€¼ï¼Œå¹¶ä¸ä¼šèµ‹æœ€ç»ˆå€¼ã€‚

![](./assets/84.svg)

* `åˆå§‹åŒ–é˜¶æ®µ`ä¼šæ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶ä¸­`clinit`æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¹¶`æ‰§è¡Œé™æ€ä»£ç å—ä¸­çš„ä»£ç `ä»¥åŠ`ä¸ºé™æ€å˜é‡èµ‹å€¼`ã€‚

> [!NOTE]
>
> clinit æ˜¯ class init çš„ç¼©å†™ï¼Œå³ï¼šç±»åˆå§‹åŒ–ï¼ˆç±»åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼‰ã€‚

![](./assets/85.png)

### 1.6.2 æ¨æ¼”

* å‡è®¾ä»£ç æ˜¯è¿™æ ·çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class Test {

    public static int count = 1;

    static {
        count = 2;
    }

    public static void main(String[] args) {

        System.out.println("count = " + count);
    }
}
```

* å…¶ç¼–è¯‘ä¹‹åï¼Œå¯¹åº”çš„å­—èŠ‚ç æ–‡ä»¶å°±æ˜¯è¿™æ ·çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

> [!NOTE]
>
> åœ¨å­—èŠ‚æ–‡ä»¶ä¸­çš„æ–¹æ³•ä¸­ä¼šå‡ºç°ä¸‰ä¸ªæ–¹æ³•ï¼š
>
> * â‘  `main` ï¼šä¸»æ–¹æ³•ï¼Œç¨‹åºçš„å…¥å£ã€‚
> * â‘¡ `<init>` ï¼šæ„é€ æ–¹æ³•ï¼ˆæ„é€ å™¨ï¼Œæ„é€ å‡½æ•°ï¼‰ä¼šåœ¨å¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œï¼Œå³ï¼š`ä½¿ç”¨`é˜¶æ®µã€‚
> * â‘¢ `<clinit>`ï¼šä¼šåœ¨`åˆå§‹åŒ–`é˜¶æ®µæ‰§è¡Œã€‚

![](./assets/86.png)

* é‚£ä¹ˆ`æºç `ã€`å­—èŠ‚ç æŒ‡ä»¤`ä»¥åŠå¯¹åº”çš„`å†…å­˜`å°±æ˜¯è¿™æ ·çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/87.svg)

### 1.6.3 å­—èŠ‚ç æŒ‡ä»¤è®²è§£

* å½“æ‰§è¡Œäº† `iconst_1` æŒ‡ä»¤ï¼Œå…¶å¯¹åº”çš„æŒ‡ä»¤æ˜¯ `iconst_<i>`ï¼Œå…¶ä¸­ `<i>` æ˜¯å¸¸é‡ã€‚

> [!NOTE]
>
> - â‘  `iconst_<i>` æŒ‡ä»¤çš„å«ä¹‰ï¼šå°†å¸¸é‡ `<i>` pushï¼ˆæ¨ï¼‰ åˆ°æ“ä½œæ•°æ ˆä¸Šã€‚
> - â‘¡ `iconst_1` æŒ‡ä»¤å°±æ˜¯å°†å¸¸é‡ `1` å‹å…¥åˆ°æ“ä½œæ•°æ ˆä¸Šã€‚

![](./assets/88.gif)

* å½“æ‰§è¡Œäº† `putstatic` æŒ‡ä»¤ï¼Œå°±æ˜¯ç»™ç±»ä¸­çš„é™æ€å˜é‡èµ‹å€¼ã€‚

> [!NOTE]
>
> `putstatic` æŒ‡ä»¤çš„å«ä¹‰ï¼šä»æ“ä½œæ•°æ ˆé¡¶ä¸­å¼¹å‡ºå€¼ï¼Œå¹¶è®¾ç½®ç»™é™æ€å˜é‡ã€‚

![](./assets/89.gif)

* å½“æ‰§è¡Œäº† `iconst_2` æŒ‡ä»¤ï¼Œå…¶å¯¹åº”çš„æŒ‡ä»¤æ˜¯ `iconst_<i>`ï¼Œå…¶ä¸­ `<i>` æ˜¯å¸¸é‡ã€‚

> [!NOTE]
>
> - â‘  `iconst_<i>` æŒ‡ä»¤çš„å«ä¹‰ï¼šå°†å¸¸é‡ `<i>` pushï¼ˆæ¨ï¼‰ åˆ°æ“ä½œæ•°æ ˆä¸Šã€‚
> - â‘¡ `iconst_2` æŒ‡ä»¤å°±æ˜¯å°†å¸¸é‡ `2` å‹å…¥åˆ°æ“ä½œæ•°æ ˆä¸Šã€‚

![](./assets/90.gif)

* å½“æ‰§è¡Œäº† `putstatic` æŒ‡ä»¤ï¼Œå°±æ˜¯ç»™ç±»ä¸­çš„é™æ€å˜é‡èµ‹å€¼ã€‚

> [!NOTE]
>
> `putstatic` æŒ‡ä»¤çš„å«ä¹‰ï¼šä»æ“ä½œæ•°æ ˆé¡¶ä¸­å¼¹å‡ºå€¼ï¼Œå¹¶è®¾ç½®ç»™é™æ€å˜é‡ã€‚

![](./assets/92.gif)

### 1.6.4 æ³¨æ„äº‹é¡¹

* å¦‚æœæˆ‘ä»¬å°†`é™æ€å˜é‡`å’Œ`é™æ€ä»£ç å—`çš„é¡ºåºé¢ å€’ä¸€ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class Test {

    static {
        count = 2;
    }
    
    public static int count = 1;

    public static void main(String[] args) {

        System.out.println("count = " + count);
    }
}
```

* å…¶å¯¹åº”çš„å­—èŠ‚ç æŒ‡ä»¤å°±æ˜¯è¿™æ ·çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/93.png)

* å¯¹æ¯”ä¸€ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/94.svg)

### 1.6.5 ç±»ç”Ÿå‘½å‘¨æœŸç›¸å…³ JVM å‚æ•°

* JDK9 ä¹‹å‰ï¼š

| ç±»ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ | å¯¹åº”æ—¥å¿—å‚æ•°                | è¾“å‡ºæ—¶æœº           | ä¿¡æ¯å†…å®¹                 |
| -------------- | --------------------------- | ------------------ | ------------------------ |
| åŠ è½½           | `-XX:+TraceClassLoading`    | å­—èŠ‚ç è¯»å…¥å†…å­˜æ—¶   | ç±»åã€æ¥æºè·¯å¾„ã€åŠ è½½å™¨   |
| é“¾æ¥-éªŒè¯      | `-XX:+TraceClassResolution` | ç¬¦å·å¼•ç”¨è§£ææ—¶     | è¢«è§£æçš„ç±»å’Œå¼•ç”¨å…³ç³»     |
| é“¾æ¥-å‡†å¤‡      | æ— ä¸“é—¨å‚æ•°                  | -                  | éœ€è¦é€šè¿‡å†…å­˜ç›‘æ§å·¥å…·è§‚å¯Ÿ |
| é“¾æ¥-è§£æ      | `-XX:+TraceClassResolution` | ç¬¦å·å¼•ç”¨è½¬ç›´æ¥å¼•ç”¨ | è§£æçš„ç¬¦å·å¼•ç”¨è¯¦æƒ…       |
| åˆå§‹åŒ–         | æ— ä¸“é—¨å‚æ•°                  | æ‰§è¡Œ`<clinit>()`æ—¶ | åˆå§‹åŒ–å¼€å§‹å’Œå®Œæˆ         |
| ä½¿ç”¨           | æ— ä¸“é—¨å‚æ•°                  | -                  | é€šè¿‡å…¶ä»–è¿è¡Œæ—¶æ—¥å¿—è§‚å¯Ÿ   |
| å¸è½½           | `-XX:+TraceClassUnloading`  | GC å›æ”¶ç±»æ—¶        | è¢«å¸è½½çš„ç±»å’ŒåŠ è½½å™¨       |

* JDK9 ä¹‹åï¼š

| ç±»ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ | å¯¹åº”æ—¥å¿—æ ‡ç­¾          | è¾“å‡ºæ—¶æœº           | ä¿¡æ¯å†…å®¹                 |
| -------------- | --------------------- | ------------------ | ------------------------ |
| åŠ è½½           | `-Xlog:class+load`    | å­—èŠ‚ç è¯»å…¥å†…å­˜æ—¶   | ç±»åã€æ¥æºè·¯å¾„ã€åŠ è½½å™¨   |
| é“¾æ¥-éªŒè¯      | `-Xlog:class+resolve` | ç¬¦å·å¼•ç”¨è§£ææ—¶     | è¢«è§£æçš„ç±»å’Œå¼•ç”¨å…³ç³»     |
| é“¾æ¥-å‡†å¤‡      | æ— ä¸“é—¨æ ‡ç­¾            | -                  | éœ€è¦é€šè¿‡å†…å­˜ç›‘æ§å·¥å…·è§‚å¯Ÿ |
| é“¾æ¥-è§£æ      | `-Xlog:class+resolve` | ç¬¦å·å¼•ç”¨è½¬ç›´æ¥å¼•ç”¨ | è§£æçš„ç¬¦å·å¼•ç”¨è¯¦æƒ…       |
| åˆå§‹åŒ–         | `-Xlog:class+init`    | æ‰§è¡Œ`<clinit>()`æ—¶ | åˆå§‹åŒ–å¼€å§‹å’Œå®Œæˆ         |
| ä½¿ç”¨           | æ— ä¸“é—¨æ ‡ç­¾            | -                  | é€šè¿‡å…¶ä»–è¿è¡Œæ—¶æ—¥å¿—è§‚å¯Ÿ   |
| å¸è½½           | `-Xlog:class+unload`  | GC å›æ”¶ç±»æ—¶        | è¢«å¸è½½çš„ç±»å’ŒåŠ è½½å™¨       |

### 1.6.6 è§¦å‘ç±»åˆå§‹åŒ–çš„æ–¹å¼

* ä¸»åŠ¨è§¦å‘ç±»åˆå§‹åŒ–çš„æ–¹å¼ï¼š

| æ–¹å¼                             | æè¿°                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| â‘  è®¿é—®ä¸€ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³• | :one: è®¿é—®é final é™æ€å˜é‡ã€‚<br>:two: ç»™é™æ€å˜é‡èµ‹å€¼ã€‚<br>:three: è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ã€‚<br> |
| â‘¡ åå°„è°ƒç”¨æˆ–åå°„åˆ›å»ºå®ä¾‹ã€‚       | :one: è°ƒç”¨ Class.forName(String className) æ–¹æ³•ï¼Œå³ï¼šä½¿ç”¨åå°„åŠ è½½ç±»ã€‚<br>:two: é€šè¿‡åå°„åˆ›å»ºå®ä¾‹å¯¹è±¡ã€‚ |
| â‘¢ ä½¿ç”¨ new å…³é”®å­—åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡  | åˆ›å»ºäº†ç±»çš„å¯¹è±¡ï¼Œå¿…ç„¶éœ€è¦å…ˆå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ã€‚ |
| â‘£ æ‰§è¡Œ main æ–¹æ³•çš„å½“å‰ç±»         | åŒ…å« main æ–¹æ³•çš„å¯åŠ¨ç±»ã€‚                                     |
| â‘¤ åˆå§‹åŒ–å­ç±»                     | åˆå§‹åŒ–å­ç±»æ—¶ä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ã€‚                                 |

> [!NOTE]
>
> ::: details ç‚¹æˆ‘æŸ¥çœ‹ å…·ä½“ç»†èŠ‚
>
> * â‘  `static final`ä¿®é¥°çš„é™æ€å¸¸é‡ï¼Œä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œå…¶åœ¨`é“¾æ¥`é˜¶æ®µä¸­çš„`å‡†å¤‡`é˜¶æ®µå°±ç›´æ¥èµ‹å€¼ã€‚
> * â‘¡ `Class.forName()` æœ‰é‡è½½æ–¹æ³•å¯ä»¥ä¸ä¸»åŠ¨è§¦å‘åˆå§‹åŒ–ã€‚
>
> ```java
> /*
> * @param initialize å¦‚æœæ˜¯ false å°±ä¸ä¸»åŠ¨è§¦å‘åˆå§‹åŒ–
> */
> public static Class<?> forName(String name,boolean initialize,ClassLoader loader) {
>     ...
> }
> ```
> * â‘¢ ç±»çš„åˆå§‹åŒ–æ‰§è¡Œé¡ºåºï¼š
>
> | æ‰§è¡Œé¡ºåº | å†…å®¹                     | è¯´æ˜                     |
> | -------- | ------------------------ | ------------------------ |
> | 1        | çˆ¶ç±»é™æ€å˜é‡å’Œé™æ€ä»£ç å— | æŒ‰åœ¨ä»£ç ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œ |
> | 2        | å­ç±»é™æ€å˜é‡å’Œé™æ€ä»£ç å— | æŒ‰åœ¨ä»£ç ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œ |
> | 3        | çˆ¶ç±»å®ä¾‹å˜é‡å’Œå®ä¾‹ä»£ç å— | åˆ›å»ºå®ä¾‹æ—¶æ‰§è¡Œ           |
> | 4        | çˆ¶ç±»æ„é€ æ–¹æ³•             | çˆ¶ç±»æ„é€ å™¨æ‰§è¡Œ           |
> | 5        | å­ç±»å®ä¾‹å˜é‡å’Œå®ä¾‹ä»£ç å— | åˆ›å»ºå®ä¾‹æ—¶æ‰§è¡Œ           |
> | 6        | å­ç±»æ„é€ æ–¹æ³•             | å­ç±»æ„é€ å™¨æ‰§è¡Œ           |
>
> * â‘£ ç±»åˆå§‹åŒ–çš„é‡è¦ç‰¹æ€§ï¼š
>
> | ç‰¹æ€§     | æè¿°                               |
> | -------- | ---------------------------------- |
> | çº¿ç¨‹å®‰å…¨ | JVM ä¿è¯ç±»åˆå§‹åŒ–è¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„   |
> | å•æ¬¡æ‰§è¡Œ | æ¯ä¸ªç±»åœ¨ JVM ä¸­åªä¼šè¢«åˆå§‹åŒ–ä¸€æ¬¡    |
> | æ‡’åŠ è½½   | ç±»åªæœ‰åœ¨é¦–æ¬¡ä¸»åŠ¨ä½¿ç”¨æ—¶æ‰ä¼šè¢«åˆå§‹åŒ– |
> | çˆ¶ç±»ä¼˜å…ˆ | å­ç±»åˆå§‹åŒ–å‰å¿…é¡»å…ˆå®Œæˆçˆ¶ç±»åˆå§‹åŒ–   |
> 
> :::



* ç¤ºä¾‹ï¼šè®¿é—®ä¸€ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•ï¼Œä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

import java.io.IOException;

public class Test {

    public static void main(String[] args) throws IOException {

        // è®¿é—®é™æ€å˜é‡
        System.out.println(Demo.count);

        // è®¿é—®é™æ€æ–¹æ³•
        System.out.println(Demo.getCount());

        // ä¿®æ”¹é™æ€å˜é‡
        Demo.count = 3;
    }
}

class Demo {
    public static int count = 1;

    static {
        
        count = 2;
    }

    public static int getCount() {
        return count;
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/95.gif)
```

:::



* ç¤ºä¾‹ï¼šåå°„è°ƒç”¨æˆ–åå°„åˆ›å»ºå®ä¾‹ï¼Œä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    public static void main(String[] args) throws Exception {

        // åå°„è°ƒç”¨
        Class.forName("com.github.thread.demo10.Demo");

        // åå°„åˆ›å»ºå®ä¾‹
        Demo.class.getDeclaredConstructor().newInstance();
    }
}

class Demo {
    public static int count = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
        count = 2;
    }

    public static int getCount() {
        return count;
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/96.gif)
```

:::



* ç¤ºä¾‹ï¼šä½¿ç”¨ new å…³é”®å­—åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡ï¼Œä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    public static void main(String[] args) throws Exception {

        // ä½¿ç”¨ new å…³é”®å­—åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡
        new Demo();
    }
}

class Demo {
    public static int count = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
        count = 2;
    }

    public static int getCount() {
        return count;
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/97.gif)
```

:::



* ç¤ºä¾‹ï¼šæ‰§è¡Œ main æ–¹æ³•çš„å½“å‰ç±»ï¼Œä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    static {
        System.out.println("Test åˆå§‹åŒ–äº†");
    }
    public static void main(String[] args) throws Exception {

        System.out.println("Test");

    }
}

class Demo {
    public static int count = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
        count = 2;
    }

    public static int getCount() {
        return count;
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/98.gif)
```

:::



* ç¤ºä¾‹ï¼šåˆå§‹åŒ–å­ç±»ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå¹¶è§¦å‘ç±»çš„åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    static {
        System.out.println("Test åˆå§‹åŒ–äº†");
    }
    public static void main(String[] args) throws Exception {

        System.out.println("Test");

    }
}

class Demo {
    public static int count = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
        count = 2;
    }

    public static int getCount() {
        return count;
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/99.gif)
```

:::

### 1.6.7 é¢è¯•é¢˜è§£æ

* ã€é—®ã€‘è¯·ç»™å‡ºä¸‹é¢ä»£ç çš„ç»“æœã€‚

```java
public class Test {

    static { // ä¼šåˆå¹¶åˆ° <cinit> å­—èŠ‚ç æŒ‡ä»¤ä¸­
        System.out.println("D");
    }

    { // ä¼šåˆå¹¶åˆ° <init> å­—èŠ‚ç æŒ‡ä»¤ä¸­
        System.out.println("C");
    }

    public Test() { // ä¼šåˆå¹¶åˆ° <init> å­—èŠ‚ç æŒ‡ä»¤ä¸­
        System.out.println("B");
    }

    public static void main(String[] args) throws Exception {
        System.out.println("A");
        new Test();
        new Test();
    }
}
```

> [!NOTE]
>
> static é™æ€æ–¹æ³•å—çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```txt
> // å°† [System.out] å‹å…¥æ“ä½œæ•°æ ˆ
> 0 getstatic #7 <java/lang/System.out : Ljava/io/PrintStream;> 
> // å°† [D] å‹å…¥æ“ä½œæ•°æ ˆï¼›æ­¤æ—¶ï¼Œæ“ä½œæ•°æ ˆå°±æ˜¯ [System.out,"D"]
> 3 ldc #28 <D> 
> // å¼¹å‡ºæ“ä½œæ•°æ ˆçš„æ ˆé¡¶å…ƒç´ ï¼Œå¹¶æ‰§è¡Œ println æ–¹æ³•ï¼Œæ‰“å° "D"
> 5 invokevirtual #15 <java/io/PrintStream.println : (Ljava/lang/String;)V>
> // æ–¹æ³•æ‰§è¡Œå®Œæ¯•
> 8 return



* ã€ç­”ã€‘D --> A --> C --> B --> C --> B

### 1.6.8 ä¸ä¼šè§¦å‘ç±»åˆå§‹åŒ–çš„æ–¹å¼

* ä¸ä¼šè§¦å‘ç±»åˆå§‹åŒ–çš„æ–¹å¼ï¼š

| æ–¹å¼                               | æè¿°                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| â‘  åˆ›å»ºæ•°ç»„                         | åˆ›å»ºæ•°ç»„å¯¹è±¡ä¸ä¼šåˆå§‹åŒ–æ•°ç»„å…ƒç´ çš„ç±»å‹ã€‚                       |
| â‘¡ ç›´æ¥è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ã€‚         | åªæœ‰çˆ¶ç±»è¢«åˆå§‹åŒ–ï¼Œå­ç±»ä¸ä¼šè¢«åˆå§‹åŒ–ã€‚                         |
| â‘¢ è®¿é—®ç¼–è¯‘æ—¶å¸¸é‡                   | final static çš„åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²å¸¸é‡åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†å€¼ï¼Œä¸éœ€è¦åˆå§‹åŒ–ç±»ã€‚ |
| â‘£ Class.forName çš„ initialize å‚æ•° | å½“ initialize å‚æ•°ä¸º false æ—¶ï¼ŒåªåŠ è½½ç±»ä½†ä¸åˆå§‹åŒ–ã€‚          |
| â‘¤ è·å– Class å¯¹è±¡                  | ä½¿ç”¨`.class`è¯­æ³•åªæ˜¯è·å–ç±»çš„å…ƒæ•°æ®ï¼Œä¸ä¼šè§¦å‘åˆå§‹åŒ–ã€‚         |



* ç¤ºä¾‹ï¼šåˆ›å»ºæ•°ç»„å¯¹è±¡ä¸ä¼šåˆå§‹åŒ–æ•°ç»„å…ƒç´ çš„ç±»å‹

::: code-group

```java [Test.java]
package com.github.thread.demo10;

import java.util.Arrays;

public class Test {

    public static void main(String[] args) throws Exception {
        Demo[] arr = new Demo[10];
        System.out.println("æ•°ç»„çš„é•¿åº¦: " + arr.length);
        System.out.println("æ•°ç»„å…ƒç´ éƒ½æ˜¯: " + Arrays.toString(arr));
    }
}

class Demo {
    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/100.gif)
```

:::



* ç¤ºä¾‹ï¼šç›´æ¥è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œåªæœ‰çˆ¶ç±»è¢«åˆå§‹åŒ–ï¼Œå­ç±»ä¸ä¼šè¢«åˆå§‹åŒ–

::: code-group

```java [Test.java]
public class Test {

    public static void main(String[] args) throws Exception {
        System.out.println(Father.a);
        System.out.println(Zi.a);
    }
}

class Father {
    public static int a = 1;

    static {
        a = 2;
        System.out.println("Father åˆå§‹åŒ–äº†");
    }
}

class Zi extends Father {
    static {
        System.out.println("Zi åˆå§‹åŒ–äº†");
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/101.gif)
```

:::



* ç¤ºä¾‹ï¼šè®¿é—®ç¼–è¯‘æ—¶å¸¸é‡ï¼Œä¸ä¼šè§¦å‘åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    public static void main(String[] args) throws Exception {
        System.out.println(Demo.a);
    }
}

class Demo {
    public static final int a = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/102.gif)
```

:::



* ç¤ºä¾‹ï¼šClass.forName çš„ `initialize` å‚æ•°ï¼Œå¦‚æœæ˜¯ false ï¼Œä¸ä¼šè§¦å‘åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    public static void main(String[] args) throws Exception {
        Class.forName("com.github.thread.demo10.Demo", 
                      false,  // [!code highlight]
                      Test.class.getClassLoader());
    }
}

class Demo {
    public static final int a = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
    }
}

```

```md:img [cmd æ§åˆ¶å°]
![](./assets/103.gif)
```

:::



* ç¤ºä¾‹ï¼šä½¿ç”¨`.class`è¯­æ³•åªæ˜¯è·å–ç±»çš„å…ƒæ•°æ®ï¼Œä¸ä¼šè§¦å‘åˆå§‹åŒ–

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    public static void main(String[] args) throws Exception {
        Class.forName("com.github.thread.demo10.Demo", 
                      false,  // [!code highlight]
                      Test.class.getClassLoader());
    }
}

class Demo {
    public static final int a = 1;

    static {
        System.out.println("Demo åˆå§‹åŒ–äº†");
    }
}

```

```md:img [cmd æ§åˆ¶å°]
![](./assets/104.gif)
```

:::

## 1.7 æ€»ç»“

* ç±»çš„ç”Ÿå‘½å‘¨æœŸçš„ä¸»è¦é˜¶æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| ç±»çš„ç”Ÿå‘½å‘¨æœŸä¸»è¦é˜¶æ®µ       | æè¿°                                                         |
| -------------------------- | ------------------------------------------------------------ |
| â‘  åŠ è½½ï¼ˆLoadingï¼‰          | ç±»çš„å­—èŠ‚ç æˆ–å®šä¹‰è¢«è¯»å…¥å†…å­˜ï¼Œä½†è¿˜æœªè¿›è¡Œåˆå§‹åŒ–ã€‚<br>è¿™é€šå¸¸å‘ç”Ÿåœ¨ç¨‹åºé¦–æ¬¡å¼•ç”¨è¯¥ç±»æ—¶ã€‚ |
| â‘¡ é“¾æ¥ï¼ˆLinkingï¼‰          | éªŒè¯ã€å‡†å¤‡å’Œè§£æã€‚<br>åŒ…æ‹¬éªŒè¯ç±»çš„ç»“æ„å®Œæ•´æ€§ã€ä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œä»¥åŠè§£æç±»ä¸­çš„ç¬¦å·å¼•ç”¨ã€‚ |
| â‘¢ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ | æ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–ä»£ç ï¼Œå¦‚ï¼šé™æ€å˜é‡èµ‹å€¼ã€é™æ€ä»£ç å—ç­‰ã€‚<br/>è¿™ä¸ªé˜¶æ®µç¡®ä¿ç±»åœ¨é¦–æ¬¡ä½¿ç”¨å‰å¤„äºæ­£ç¡®çŠ¶æ€ã€‚ |
| â‘£ ä½¿ç”¨ï¼ˆUsingï¼‰            | ç±»è¢«å®ä¾‹åŒ–åˆ›å»ºå¯¹è±¡ï¼Œæˆ–è€…ç›´æ¥è®¿é—®é™æ€æˆå‘˜ã€‚<br/>è¿™æ˜¯ç±»å‘æŒ¥å®é™…ä½œç”¨çš„é˜¶æ®µã€‚ |
| â‘¤ å¸è½½ï¼ˆUnloadingï¼‰        | å½“ç±»ä¸å†è¢«å¼•ç”¨ä¸”æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å¯èƒ½ä¼šå¸è½½è¯¥ç±»ï¼Œé‡Šæ”¾ç›¸å…³å†…å­˜ã€‚ |

* å…¶å¯¹åº”çš„æµç¨‹å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```mermaid
flowchart TD
    A[ç¨‹åºå¯åŠ¨] --> B{é¦–æ¬¡å¼•ç”¨ç±»?}
    B -->|æ˜¯| C[â‘  åŠ è½½ Loading]
    B -->|å¦| H[ç»§ç»­æ‰§è¡Œ]
    
    C --> D[â‘¡ é“¾æ¥ Linking]
    D --> E[â‘¢ åˆå§‹åŒ– Initialization]
    E --> F[â‘£ ä½¿ç”¨ Using]
    F --> G{ç±»è¿˜è¢«å¼•ç”¨?}
    G -->|æ˜¯| F
    G -->|å¦| I[â‘¤ å¸è½½ Unloading]
    I --> J[å†…å­˜é‡Šæ”¾]
    
    subgraph åŠ è½½é˜¶æ®µ["â‘  åŠ è½½ Loading"]
        C1[è¯»å…¥å­—èŠ‚ç åˆ°å†…å­˜<br/>æœªè¿›è¡Œåˆå§‹åŒ–]
    end
    
    subgraph é“¾æ¥é˜¶æ®µ["â‘¡ é“¾æ¥ Linking"]
        D1[éªŒè¯ç±»ç»“æ„å®Œæ•´æ€§]
        D2[ä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜]
        D3[è§£æç¬¦å·å¼•ç”¨]
        D1 --> D2 --> D3
    end
    
    subgraph åˆå§‹åŒ–é˜¶æ®µ["â‘¢ åˆå§‹åŒ– Initialization"]
        E1[æ‰§è¡Œé™æ€å˜é‡èµ‹å€¼]
        E2[æ‰§è¡Œé™æ€ä»£ç å—]
        E1 --> E2
    end
    
    subgraph ä½¿ç”¨é˜¶æ®µ["â‘£ ä½¿ç”¨ Using"]
        F1[åˆ›å»ºå¯¹è±¡å®ä¾‹]
        F2[è®¿é—®é™æ€æˆå‘˜]
        F1 -.-> F2
    end
    
    subgraph å¸è½½é˜¶æ®µ["â‘¤ å¸è½½ Unloading"]
        I1[æ»¡è¶³å¸è½½æ¡ä»¶]
        I2[åƒåœ¾å›æ”¶å™¨æ¸…ç†]
        I1 --> I2
    end
    
    C --> C1
    D --> D1
    E --> E1
    F --> F1
    I --> I1
    
    style åŠ è½½é˜¶æ®µ fill:#e1f5fe,stroke:#01579b
    style é“¾æ¥é˜¶æ®µ fill:#f3e5f5,stroke:#4a148c
    style åˆå§‹åŒ–é˜¶æ®µ fill:#e8f5e8,stroke:#1b5e20
    style ä½¿ç”¨é˜¶æ®µ fill:#fff3e0,stroke:#e65100
    style å¸è½½é˜¶æ®µ fill:#ffebee,stroke:#b71c1c
    
    style C fill:#b3e5fc
    style D fill:#e1bee7
    style E fill:#c8e6c9
    style F fill:#ffe0b2
    style I fill:#ffcdd2

```





# ç¬¬äºŒç« ï¼šç±»åŠ è½½å™¨ï¼ˆâ­ï¼‰

## 2.1 æ¦‚è¿°

* ç±»ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯`åŠ è½½`ï¼Œå…¶æ˜¯é€šè¿‡`ç±»åŠ è½½å™¨`å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­çš„ã€‚

![](./assets/58.svg)

* ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰æ˜¯ JVM æä¾›ç»™åº”ç”¨ç¨‹åºå»è·å–`å­—èŠ‚ç æ•°æ®`çš„æŠ€æœ¯ã€‚

> [!NOTE]
>
> * â‘  ç±»åŠ è½½å™¨ä¼šé€šè¿‡äºŒè¿›åˆ¶æµçš„æ–¹å¼å°†å­—èŠ‚ç æ–‡ä»¶çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¹‹åå°†æ•°æ®äº¤ç»™ JVMï¼ŒJVM ä¼šåœ¨æ–¹æ³•åŒºå’Œå †ä¸Šç”Ÿæˆå¯¹åº”çš„å¯¹è±¡å»ä¿å­˜å­—èŠ‚ç ä¿¡æ¯ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚
> * â‘¡ ç±»åŠ è½½å™¨åªå‚ä¸`åŠ è½½`è¿‡ç¨‹ä¸­çš„å­—èŠ‚ç è·å–å¹¶åŠ è½½åˆ°å†…å­˜ä¸­è¿™ä¸€éƒ¨åˆ†ã€‚

![](./assets/105.svg)

## 2.2 ç±»åŠ è½½å™¨çš„å®é™…åº”ç”¨åœºæ™¯

* åœ¨å®é™…å¼€å‘ä¸­ï¼Œé¡¹ç›®ä¸­çš„`å­—èŠ‚ç æ–‡ä»¶`éƒ½ä¾èµ–äºç±»åŠ è½½å™¨ï¼Œå¹¶ä¸”è¿™äº›ç±»åŠ è½½å™¨æ˜¯ JDK å¼€ç®±æä¾›çš„ï¼Œå¯¹ç¨‹åºå‘˜æ¥è¯´æ˜¯é€æ˜çš„ï¼Œå¥½åƒå¯ä»¥ä¸ç”¨å•ç‹¬å­¦ä¹ è¿™éƒ¨åˆ†å†…å®¹ï¼Ÿ

![](./assets/106.png)

* å…¶å®ï¼Œç±»åŠ è½½å™¨åœ¨ä¼ä¸šä¸­åº”ç”¨å¾—éå¸¸å¹¿æ³›ã€‚

| åº”ç”¨åœºæ™¯     | æè¿°                                                         |
| ------------ | ------------------------------------------------------------ |
| ä¼ä¸šçº§åº”ç”¨   | :one: SPI æœºåˆ¶ï¼Œå¦‚ï¼šJDBCã€Spring æ¡†æ¶ä»¥åŠ Dubbo æ¡†æ¶ç­‰ã€‚<br>:two: ç±»çš„çƒ­éƒ¨ç½²ã€‚<br>:three: Tomcat ç±»çš„éš”ç¦»ã€‚<br> |
| å¤§é‡çš„é¢è¯•é¢˜ | :one: ä»€ä¹ˆæ˜¯ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ<br>:two: å¦‚ä½•æ‰“ç ´ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ<br>:three: è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚ |
| è§£å†³çº¿ä¸Šé—®é¢˜ | :star: ä½¿ç”¨ Arthas åœ¨ç¨‹åºä¸åœæœºçš„æƒ…å†µä¸‹ç›´æ¥ä¿®å¤çº¿ä¸Šæ•…éšœã€‚    |

## 2.3 ç±»åŠ è½½å™¨çš„åˆ†ç±»

### 2.3.1 æ¦‚è¿°

* ç±»åŠ è½½å™¨ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š

| ç±»åŠ è½½çš„åˆ†ç±»                   | æè¿°                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| â‘  JVM åº•å±‚æºç ä¸­å®ç°çš„ç±»åŠ è½½å™¨ | :one: ç±»åŠ è½½å™¨æºä»£ç ä½äºJava è™šæ‹Ÿæœºçš„æºç ä¸­ï¼Œå®ç°è¯­è¨€ä¸è™šæ‹Ÿæœºåº•å±‚è¯­è¨€ä¸€è‡´ï¼Œå¦‚ï¼šHotspot ä½¿ç”¨ C++ã€‚<br>:two: ä¸»è¦ç›®çš„æ˜¯ä¿è¯ Java ç¨‹åºè¿è¡Œä¸­åŸºç¡€ç±»è¢«æ­£ç¡®åœ°åŠ è½½ï¼Œå¦‚ï¼šjava.lang.Stringï¼ŒJava è™šæ‹Ÿæœºéœ€è¦ç¡®ä¿å…¶å¯é æ€§ã€‚ |
| â‘¡ Java ä»£ç ä¸­å®ç°çš„ç±»åŠ è½½å™¨    | :one: JDK ä¸­é»˜è®¤æä¾›äº†å¤šç§å¤„ç†ä¸åŒæ¸ é“çš„ç±»åŠ è½½å™¨ï¼Œç¨‹åºå‘˜ä¹Ÿå¯ä»¥è‡ªå·±æ ¹æ®éœ€æ±‚å®šåˆ¶ã€‚<br>:two: æ‰€æœ‰ Java ä¸­å®ç°çš„ç±»åŠ è½½å™¨éƒ½éœ€è¦ç»§æ‰¿ `ClassLoader` è¿™ä¸ªæŠ½è±¡ç±»ã€‚ |

* ç±»åŠ è½½å™¨çš„è®¾è®¡åœ¨ JDK8 å’Œ JDK8+ ç‰ˆæœ¬çš„å·®åˆ«è¾ƒå¤§ï¼Œæš‚æ—¶ä»¥ JDK8 ä½œä¸ºåŸºå‡†æ¥æ¢è®¨ï¼š

![](./assets/107.png)

* ç±»åŠ è½½å™¨çš„è¯¦ç»†ä¿¡æ¯åœ¨ Arthas é€šè¿‡å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼š

> [!NOTE]
>
> * â‘  BootstrapClassLoader æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ŒnumberOfInstances è¡¨ç¤ºç±»åŠ è½½çš„æ•°é‡ï¼Œè€Œ loadedCountTotal è¡¨ç¤ºåŠ è½½ç±»çš„æ•°é‡ã€‚
> * â‘¡ ExtClassLoader æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œè€Œ AppClassLoader æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚

::: code-group

```bash
classloader -t
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/108.gif)
```

:::

### 2.3.2 å¯åŠ¨ç±»åŠ è½½å™¨

#### 2.3.2.1 æ¦‚è¿°

* å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰æ˜¯ç”± Hotspot è™šæ‹Ÿæœºæä¾›çš„ï¼Œæ˜¯ä½¿ç”¨ C++ ç¼–å†™çš„ç±»åŠ è½½å™¨ã€‚

> [!NOTE]
>
> ä½œä¸º Java ç¨‹åºå‘˜å¾ˆéš¾å»ä¿®æ”¹æˆ–æ‰©å±•`å¯åŠ¨ç±»åŠ è½½å™¨`çš„æºç ï¼Œåªéœ€è¦äº†è§£å…¶ä½œç”¨å³å¯ã€‚

* å¯åŠ¨ç±»åŠ è½½å™¨é»˜è®¤ä¼šåŠ è½½ `$JAVA_HOME/jre/lib/` ç›®å½•ä¸‹çš„ç±»æ–‡ä»¶ï¼Œå¦‚ï¼šrt.jar ã€tools.jar ä»¥åŠ resources.jar ç­‰ã€‚

> [!NOTE]
>
> ::: details ç‚¹æˆ‘æŸ¥çœ‹ jar åŒ…æ˜¯ä»€ä¹ˆï¼Ÿ
>
> * â‘  jar åŒ…çš„æœ¬è´¨ï¼šå°±æ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œä½¿ç”¨ ZIP æ ¼å¼è¿›è¡Œå‹ç¼©ï¼Œä½†æ‰©å±•åä¸º`.jar`ã€‚å®ƒå°†å¤šä¸ªJava ç±»æ–‡ä»¶ã€èµ„æºæ–‡ä»¶ã€å…ƒæ•°æ®ç­‰æ‰“åŒ…åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ã€‚
>
> * â‘¡ jar çš„ä¸»è¦ä½œç”¨ï¼š
>
>   * :one: `ä»£ç æ‰“åŒ…å’Œåˆ†å‘`ï¼šå°†ç¼–è¯‘åçš„ .class æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€å›¾ç‰‡ç­‰èµ„æºç»Ÿä¸€æ‰“åŒ…ï¼Œä¾¿äºåˆ†å‘å’Œéƒ¨ç½²ã€‚ä¸€ä¸ªå¤æ‚çš„ Java åº”ç”¨å¯èƒ½åŒ…å«æ•°ç™¾ä¸ªç±»æ–‡ä»¶ï¼ŒJAR åŒ…å°†å®ƒä»¬æ•´åˆä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚
>
>   * :two: `ä¾èµ–ç®¡ç†`ï¼šå¯ä»¥å°†ç¬¬ä¸‰æ–¹åº“æ‰“åŒ…æˆ JAR æ–‡ä»¶ï¼Œå…¶ä»–é¡¹ç›®é€šè¿‡å¼•ç”¨è¿™äº› JAR åŒ…æ¥ä½¿ç”¨ç›¸åº”åŠŸèƒ½ï¼Œé¿å…é‡å¤å¼€å‘ã€‚
>
>   * :three: `ç®€åŒ–éƒ¨ç½²`ï¼šç‰¹åˆ«æ˜¯å¯æ‰§è¡Œ JAR åŒ…ï¼Œå¯ä»¥é€šè¿‡`java -jar xxx.jar`å‘½ä»¤ç›´æ¥è¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šç±»è·¯å¾„ã€‚
>
>   * :four: `ç‰ˆæœ¬æ§åˆ¶`ï¼šé€šè¿‡ä¸åŒç‰ˆæœ¬çš„ JAR åŒ…æ¥ç®¡ç†è½¯ä»¶çš„ä¸åŒç‰ˆæœ¬ï¼Œä¾¿äºç»´æŠ¤å’Œå‡çº§ã€‚
>
> * â‘¢ jar åŒ…çš„ç»“æ„ï¼š
>   * :one: `ç¼–è¯‘åçš„ Java ç±»æ–‡ä»¶`ï¼ˆ.classï¼‰ã€‚
>   * :two: `META-INF ç›®å½•`ï¼šåŒ…å« MANIFEST.MF æ¸…å•æ–‡ä»¶ç­‰å…ƒæ•°æ®ã€‚
>   * :three: `èµ„æºæ–‡ä»¶`ï¼Œå¦‚ï¼šé…ç½®æ–‡ä»¶ã€å›¾ç‰‡ã€æ–‡æœ¬ç­‰ã€‚
>   * :four: `å¯é€‰çš„æ•°å­—ç­¾åä¿¡æ¯`ã€‚
>
> :::

 ![](./assets/109.png)



> [!IMPORTANT]
>
> * â‘  åœ¨å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ jar åŒ…ä¸­æœ€é‡è¦çš„å°±æ˜¯ rt.jar ï¼Œå› ä¸ºæˆ‘ä»¬å¹³å¸¸ç»å¸¸ä½¿ç”¨çš„ Stringã€Integer ç­‰éƒ½ä½äºè¯¥ jar åŒ…ä¸­ã€‚
> * â‘¡ å½“ JVM å¯åŠ¨çš„æ—¶å€™ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨å°±ä¼šå°†ä¸Šè¿° jar åŒ…ä¸­çš„ç±»éƒ½åŠ è½½è¿›æ¥ï¼Œä¸ºç¨‹åºæä¾›ä¸€ä¸ªåŸºç¡€çš„è¿è¡Œç¯å¢ƒã€‚

#### 2.3.2.2 éªŒè¯å¯åŠ¨ç±»åŠ è½½å™¨

* å¯ä»¥é€šè¿‡ String çš„ Class å¯¹è±¡çš„ getClassLoader() æ–¹æ³•æ¥è·å–å¯åŠ¨ç±»åŠ è½½å™¨ï¼š

::: code-group

```java [Test.java]
package com.github.thread.demo10;

public class Test {

    public static void main(String[] args) throws Exception {
        ClassLoader classLoader = String.class.getClassLoader();
        // ç»“æœæ˜¯ null ï¼Œæ˜¯å› ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨åœ¨ JDK8 ä¸­æ˜¯ç”± C++ ç¼–å†™çš„
        // åœ¨ Java ä»£ç ä¸­å»è·å–æ—¢ä¸åˆé€‚ï¼Œä¹Ÿä¸å®‰å…¨
        // å¦‚æœè¿”å›çš„ç±»åŠ è½½å™¨æ˜¯ nullï¼Œå°±è¯æ˜æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨
        System.out.println("classLoader = " + classLoader);
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/110.gif)
```

:::

* ä¹Ÿå¯ä»¥åœ¨ Arthas ä¸­é€šè¿‡ `sc -d ç±»å` å‘½ä»¤å»æŸ¥çœ‹åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼š

::: code-group

```bash
sc -d java.lang.String
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/111.gif)
```

:::

#### 2.3.2.3 ç”¨æˆ·æ‰©å±•åŸºç¡€ jar åŒ…

* æœ‰æ—¶ï¼Œç”¨æˆ·å¸Œæœ›æ‰©å±•ä¸€äº›æ¯”è¾ƒåŸºç¡€çš„ jar åŒ…ï¼Œä»¥ä¾¿è®©å¯åŠ¨ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œæœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š

| æ–¹å¼                                               | æè¿°                                                         |
| -------------------------------------------------- | ------------------------------------------------------------ |
| â‘  ~~`å°† jar åŒ…æ”¾å…¥ jar/lib ä¸‹è¿›è¡Œæ‰©å±•`~~ï¼ˆä¸æ¨èï¼‰ | å°½é‡ä¸è¦å»æ›´æ”¹ JDK å®‰è£…ç›®å½•ä¸­çš„å†…å®¹ï¼Œå¯èƒ½ä¼šå‡ºç°å³ä½¿æ”¾è¿›å»ä¹Ÿä¼šç”±äºæ–‡ä»¶åä¸åŒ¹é…ç­‰é—®é¢˜è€Œä¸ä¼šæ­£å¸¸çš„åŠ è½½ã€‚ |
| â‘¡ `ä½¿ç”¨å‚æ•°è¿›è¡Œæ‰©å±•`ï¼ˆæ¨èï¼‰                       | ä½¿ç”¨ `-Xbootclasspath/a:jaråŒ…ç›®å½•/jaråŒ…å`è¿›è¡Œæ‰©å±•ï¼Œ`/a`è¡¨ç¤ºæ–°å¢ã€‚ |



* ç¤ºä¾‹ï¼šæ­å»º Maven å¤šæ¨¡å—é¡¹ç›®

::: code-group

```txt [é¡¹ç›®ç»“æ„]
â”œâ”€ğŸ“ .idea
â”œâ”€ğŸ“ .mvn
â”œâ”€ğŸ“ jvm-extend-------------------- # æ‰©å±•é¡¹ç›®
â”‚â€ƒâ”œâ”€ğŸ“ src
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ main
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ java
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ  â””â”€ğŸ“ com
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ    â””â”€ğŸ“ github
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â””â”€ğŸ“ domain
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ        â””â”€ğŸ“„ Student.java---- # æ‰©å±•ç±»
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ test
â”‚â€ƒâ””â”€ğŸ“„ pom.xml--------------------- # å­é¡¹ç›®çš„ pom.xml
â”œâ”€ğŸ“ jvm-test---------------------- # æµ‹è¯•é¡¹ç›®
â”‚â€ƒâ”œâ”€ğŸ“ src
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ main
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ java
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ  â””â”€ğŸ“ com
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ    â””â”€ğŸ“ github
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â””â”€ğŸ“„ App.java---------- # æµ‹è¯•ç±»
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ test
â”‚â€ƒâ””â”€ğŸ“„ pom.xml--------------------- # å­é¡¹ç›®çš„ pom.xml
â”œâ”€ğŸ“„ .gitignore
â””â”€ğŸ“„ pom.xml----------------------- # çˆ¶é¡¹ç›® pom.xml
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/112.gif)
```

```java [jvm-extend/Student.java]
package com.github.domain;

public class Student {

    static {
        System.out.println("Student åŠ è½½äº†...");
    }
}
```

```java [jvm-test/App.java]
package com.github;

public class App {
    public static void main( String[] args ) throws ClassNotFoundException {

        Class<?> aClass = Class.forName("com.github.domain.Student");

        System.out.println(aClass);

        System.out.println( "Hello World!" );
    }
}

```

:::



* ç¤ºä¾‹ï¼šIDEA é…ç½® JVM å‚æ•°

::: code-group

```txt [IDEA é…ç½® JVM å‚æ•°]
-Xbootclasspath/a:D:/project/jvm/jvm-extend/target/jvm-extend-1.0.jar
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/113.gif)
```

:::

### 2.3.3 æ‰©å±•ç±»åŠ è½½å™¨

#### 2.3.3.1 æ¦‚è¿°

* `æ‰©å±•ç±»åŠ è½½å™¨`å’Œ`åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`éƒ½æ˜¯ JDK ä¸­æä¾›çš„ï¼Œå¹¶ä¸”ä½¿ç”¨ Java ç¼–å†™çš„ç±»åŠ è½½å™¨ã€‚
* å…¶æºç éƒ½ä½äº `sun.misc.Launcher` ä¸­ï¼Œå¹¶ä¸”éƒ½æ˜¯é™æ€å†…éƒ¨ç±»ï¼Œä¹Ÿæ˜¯ `URLClassLoader`çš„å­ç±»ã€‚

> [!NOTE]
>
> URLClassLoader å¯ä»¥ä»æŒ‡å®š URL ä½ç½®ï¼ˆJAR åŒ…ã€ç›®å½•è·¯å¾„ã€ç½‘ç»œåœ°å€ï¼‰åŠ¨æ€åŠ è½½ Java ç±»æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚

```java
package sun.misc;

...

public class Launcher {
    
    static class ExtClassLoader extends URLClassLoader {}
    
    static class AppClassLoader extends URLClassLoader {}
    
}
```

* å…¶ç±»ç»§æ‰¿å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/114.png)

* æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰é»˜è®¤åŠ è½½çš„æ˜¯ `$JAVA_HOME/jre/lib/ext`ç›®å½•ä¸‹çš„ç±»æ–‡ä»¶ã€‚

![](./assets/115.png)

* å¯ä»¥é€šè¿‡ `Arthas` æ¥æŸ¥çœ‹`æ‰©å±•ç±»åŠ è½½å™¨`åŠ è½½çš„è·¯å¾„ï¼ˆç›®å½•ï¼‰ï¼š

::: code-group

```bash
# æŸ¥çœ‹ç±»åŠ è½½å™¨çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬ hash
classloader -l 
# æŸ¥çœ‹æŒ‡å®šç±»åŠ è½½å™¨åŠ è½½çš„å†…å®¹
classloader -c <hash>
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/119.gif)
```

:::

#### 2.3.3.2 éªŒè¯æ‰©å±•ç±»åŠ è½½å™¨

* å¯ä»¥é€šè¿‡ ScriptEnvironment çš„ Class å¯¹è±¡çš„ getClassLoader() æ–¹æ³•æ¥è·å–å¯åŠ¨ç±»åŠ è½½å™¨ï¼š

::: code-group

```java [Test.java]
package com.github.thread.demo10;

import jdk.nashorn.internal.runtime.ScriptEnvironment;

public class Test {

    public static void main(String[] args) throws Exception {
        ClassLoader classLoader = ScriptEnvironment.class.getClassLoader();
        System.out.println("classLoader = " + classLoader);
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/116.gif)
```

:::

* ä¹Ÿå¯ä»¥åœ¨ Arthas ä¸­é€šè¿‡ `sc -d ç±»å` å‘½ä»¤å»æŸ¥çœ‹åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼š

::: code-group

```bash
sc -d jdk.nashorn.internal.runtime.ScriptEnvironment
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/117.gif)
```

:::

#### 2.3.3.3 åŠ è½½ç”¨æˆ· jar åŒ…

* æœ‰æ—¶ï¼Œç”¨æˆ·å¸Œæœ›æ‰©å±•ç±»åŠ è½½å™¨èƒ½åŠ è½½è‡ªå®šä¹‰çš„ jar åŒ…ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š

| æ–¹å¼                                                   | æè¿°                                                         |
| ------------------------------------------------------ | ------------------------------------------------------------ |
| â‘  ~~`å°† jar åŒ…æ”¾å…¥ jar/lib/ext ä¸‹è¿›è¡Œæ‰©å±•`~~ï¼ˆä¸æ¨èï¼‰ | å°½é‡ä¸è¦å»æ›´æ”¹ JDK å®‰è£…ç›®å½•ä¸­çš„å†…å®¹ï¼Œå¯èƒ½ä¼šå‡ºç°å³ä½¿æ”¾è¿›å»ä¹Ÿä¼šç”±äºæ–‡ä»¶åä¸åŒ¹é…ç­‰é—®é¢˜è€Œä¸ä¼šæ­£å¸¸çš„åŠ è½½ã€‚ |
| â‘¡ `ä½¿ç”¨å‚æ•°è¿›è¡Œæ‰©å±•`ï¼ˆæ¨èï¼‰                           | ä½¿ç”¨`-Djava.ext.dirs=jaråŒ…ç›®å½•`å‚æ•°è¿›è¡Œæ‰©å±•ï¼Œä¼šè¦†ç›–åŸå§‹ç›®å½•ã€‚<br>å¯ä»¥ä½¿ç”¨ `;`ï¼ˆWindowsï¼‰ æˆ– `:`ï¼ˆLinuxï¼‰è¿½åŠ åŸå§‹ç›®å½•ã€‚ |



* ç¤ºä¾‹ï¼šæ­å»º Maven å¤šæ¨¡å—é¡¹ç›®

::: code-group

```txt [é¡¹ç›®ç»“æ„]
â”œâ”€ğŸ“ .idea
â”œâ”€ğŸ“ .mvn
â”œâ”€ğŸ“ jvm-extend-------------------- # æ‰©å±•é¡¹ç›®
â”‚â€ƒâ”œâ”€ğŸ“ src
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ main
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ java
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ  â””â”€ğŸ“ com
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ    â””â”€ğŸ“ github
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â””â”€ğŸ“ domain
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ        â””â”€ğŸ“„ Student.java---- # æ‰©å±•ç±»
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ test
â”‚â€ƒâ””â”€ğŸ“„ pom.xml--------------------- # å­é¡¹ç›®çš„ pom.xml
â”œâ”€ğŸ“ jvm-test---------------------- # æµ‹è¯•é¡¹ç›®
â”‚â€ƒâ”œâ”€ğŸ“ src
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ main
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ java
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ  â””â”€ğŸ“ com
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ    â””â”€ğŸ“ github
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â””â”€ğŸ“„ App.java---------- # æµ‹è¯•ç±»
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ test
â”‚â€ƒâ””â”€ğŸ“„ pom.xml--------------------- # å­é¡¹ç›®çš„ pom.xml
â”œâ”€ğŸ“„ .gitignore
â””â”€ğŸ“„ pom.xml----------------------- # çˆ¶é¡¹ç›® pom.xml
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/112.gif)
```

```java [jvm-extend/Student.java]
package com.github.domain;

public class Student {

    static {
        System.out.println("Student åŠ è½½äº†...");
    }
}
```

```java [jvm-test/App.java]
package com.github;

public class App {
    public static void main( String[] args ) throws ClassNotFoundException {

        Class<?> aClass = Class.forName("com.github.domain.Student");

        System.out.println(aClass);

        System.out.println( "Hello World!" );
    }
}

```

:::



* ç¤ºä¾‹ï¼šIDEA é…ç½® JVM å‚æ•°

::: code-group

```txt [IDEA é…ç½® JVM å‚æ•°]
-Djava.ext.dirs="D:/develop/java/oracle/jdk1.8.0_131/jre/lib/ext;D:/project/jvm/jvm-extend/target"
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/118.gif)
```

:::

### 2.3.4 åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨

#### 2.3.4.1 æ¦‚è¿°

* `æ‰©å±•ç±»åŠ è½½å™¨`å’Œ`åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`éƒ½æ˜¯ JDK ä¸­æä¾›çš„ï¼Œå¹¶ä¸”ä½¿ç”¨ Java ç¼–å†™çš„ç±»åŠ è½½å™¨ã€‚
* å…¶æºç éƒ½ä½äº `sun.misc.Launcher` ä¸­ï¼Œå¹¶ä¸”éƒ½æ˜¯é™æ€å†…éƒ¨ç±»ï¼Œä¹Ÿæ˜¯ `URLClassLoader`çš„å­ç±»ã€‚

> [!NOTE]
>
> URLClassLoader å¯ä»¥ä»æŒ‡å®š URL ä½ç½®ï¼ˆJAR åŒ…ã€ç›®å½•è·¯å¾„ã€ç½‘ç»œåœ°å€ï¼‰åŠ¨æ€åŠ è½½ Java ç±»æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚

```java
package sun.misc;

...

public class Launcher {
    
    static class ExtClassLoader extends URLClassLoader {}
    
    static class AppClassLoader extends URLClassLoader {}
    
}
```

* å…¶ç±»ç»§æ‰¿å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/114.png)

* åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰é»˜è®¤ä¼šåŠ è½½ classpath ä¸‹çš„ç±»æ–‡ä»¶ã€‚

> [!NOTE]
>
> é»˜è®¤åŠ è½½çš„æ˜¯é¡¹ç›®ä¸­çš„ç±»æ–‡ä»¶ä»¥åŠ Maven ç­‰æ„å»ºå·¥å…·å¯¼å…¥çš„ç¬¬ä¸‰æ–¹ jar åŒ…ä¸­çš„ç±»æ–‡ä»¶ã€‚

* å¯ä»¥é€šè¿‡ `Arthas` æ¥æŸ¥çœ‹`åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`åŠ è½½çš„è·¯å¾„ï¼ˆç›®å½•ï¼‰ï¼š

::: code-group

```bash
# æŸ¥çœ‹ç±»åŠ è½½å™¨çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬ hash
classloader -l 
# æŸ¥çœ‹æŒ‡å®šç±»åŠ è½½å™¨åŠ è½½çš„å†…å®¹
classloader -c <hash>
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/120.gif)
```

::: 

#### 2.3.4.2 éªŒè¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨

* å¯ä»¥é€šè¿‡ Student çš„ Class å¯¹è±¡çš„ getClassLoader() æ–¹æ³•æ¥è·å–å¯åŠ¨ç±»åŠ è½½å™¨ï¼š

::: code-group

```java [Student.java]
package com.github;

public class Student {

  static {
    System.out.println("Student åŠ è½½äº†...");
  }
}
```

```java [Test.java]
package com.github;

import org.apache.commons.io.FileUtils;

import java.io.IOException;

public class Test {
    public static void main(String[] args) throws IOException {
        ClassLoader classLoader = Student.class.getClassLoader();
        System.out.println(classLoader);
        classLoader = FileUtils.class.getClassLoader();
        System.out.println(classLoader);
    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/121.gif)
```

:::

* ä¹Ÿå¯ä»¥åœ¨ Arthas ä¸­é€šè¿‡ `sc -d ç±»å` å‘½ä»¤å»æŸ¥çœ‹åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼š

::: code-group

```bash
sc -d org.apache.commons.io.FileUtils
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/122.gif)
```

:::

### 2.3.5 æ€»ç»“

* ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```mermaid
graph TD
    A[å¯åŠ¨ç±»åŠ è½½å™¨<br/>Bootstrap ClassLoader<br/>è™šæ‹Ÿæœºåº•å±‚å®ç°] --> B[æ‰©å±•ç±»åŠ è½½å™¨<br/>Extension ClassLoader<br/>Javaè¯­è¨€å®ç°]
    B --> C[åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨<br/>Application ClassLoader<br/>ç³»ç»Ÿç±»åŠ è½½å™¨<br/>Javaè¯­è¨€å®ç°]
    C --> D[è‡ªå®šä¹‰ç±»åŠ è½½å™¨1<br/>Custom ClassLoader 1<br/>Javaè¯­è¨€å®ç°]
    C --> E[è‡ªå®šä¹‰ç±»åŠ è½½å™¨2<br/>Custom ClassLoader 2<br/>Javaè¯­è¨€å®ç°]
    C --> F[è‡ªå®šä¹‰ç±»åŠ è½½å™¨N<br/>Custom ClassLoader N<br/>Javaè¯­è¨€å®ç°]
    
    %% åŠ è½½å†…å®¹è¯´æ˜
    A1[æ ¸å¿ƒç±»åº“<br/>java.lang.*<br/>java.util.*<br/>$JAVA_HOME/jre/lib] -.-> A
    B1[æ‰©å±•ç±»åº“<br/>$JAVA_HOME/jre/lib/ext<br/>java.ext.dirsè·¯å¾„] -.-> B
    C1[åº”ç”¨ç¨‹åºç±»<br/>classpathè·¯å¾„<br/>ç”¨æˆ·è‡ªå®šä¹‰ç±»] -.-> C
    D1[ç½‘ç»œåŠ è½½<br/>æ•°æ®åº“åŠ è½½<br/>åŠ å¯†è§£å¯†<br/>çƒ­éƒ¨ç½²] -.-> D
    
    %% æ ·å¼å®šä¹‰
    classDef bootstrap fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef extension fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef application fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef custom fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef content fill:#f5f5f5,stroke:#616161,stroke-width:1px,stroke-dasharray: 5 5
    
    class A bootstrap
    class B extension
    class C application
    class D,E,F custom
    class A1,B1,C1,D1 content
```

## 2.4 åŒäº²å§”æ´¾æœºåˆ¶

### 2.4.1 æ¦‚è¿°

* ç”±äº JVM ä¸­å­˜åœ¨å¤šä¸ª`ç±»åŠ è½½å™¨`ï¼Œå¦‚æœéœ€è¦åŠ è½½ä¸€ä¸ªç±»ï¼Œåˆ°åº•åº”è¯¥ç”±é‚£ä¸ª`ç±»åŠ è½½`æ¥å®Œæˆï¼Ÿ

![](./assets/123.svg)

* æœ‰äººå¯èƒ½è®¤ä¸ºä¸Šè¿°`ç±»åŠ è½½å™¨`åŠ è½½ç›®å½•ä¸åŒï¼Œå¯ä»¥æ ¹æ®ç›®å½•æ¥ç¡®å®šè¯¥ç±»ç”±é‚£ä¸ª`ç±»åŠ è½½å™¨`æ¥åŠ è½½ï¼Ÿ

> [!NOTE]
>
> å¦‚æœæˆ‘å°†`è¯¥ç±»æ‰€åœ¨çš„ç›®å½•`é…ç½®åˆ°ä¸Šè¿°`ç±»åŠ è½½å™¨`åŠ è½½çš„ç›®å½•ä¸­ï¼Œé‚£ä¹ˆè¯¥ç±»åˆè¯¥ç”±é‚£ä¸ª`ç±»åŠ è½½`å®Œæˆï¼Ÿ

![](./assets/124.svg)

* å¦‚æœè¦è§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å­¦ä¹ `åŒäº²å§”æ´¾æœºåˆ¶`ï¼ˆçˆ¶ç±»å§”æ´¾æ¨¡å‹ï¼‰ã€‚

> [!IMPORTANT]
>
> åŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒå°±æ˜¯`è§£å†³åœ¨å¤šä¸ªç±»åŠ è½½å™¨å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç±»åˆ°åº•ç”±é‚£ä¸ªåŠ è½½å™¨æ¥åŠ è½½çš„é—®é¢˜`ã€‚

### 2.4.2 åŒäº²å§”æ´¾æœºåˆ¶çš„ä½œç”¨

* â‘  `ä¿è¯ç±»åŠ è½½çš„å®‰å…¨æ€§`ï¼šé€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶é¿å…æ¶æ„ä»£ç æ›¿æ¢ JDK ä¸­çš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚ï¼šjava.lang.Stringï¼Œç¡®ä¿æ ¸å¿ƒç±»åº“çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚
* â‘¡ `é¿å…é‡å¤åŠ è½½`ï¼šåŒäº²å§”æ´¾æœºåˆ¶å¯ä»¥é¿å…åŒä¸€ä¸ªç±»è¢«å¤šæ¬¡åŠ è½½ï¼Œå‡å°‘åŠ è½½è¿‡ç¨‹ä¸­çš„æ€§èƒ½å¼€é”€ã€‚

### 2.4.3 åŒäº²å§”æ´¾æœºåˆ¶

#### 2.4.3.1 æ¦‚è¿°

* åŒäº²å§”æ´¾æœºåˆ¶ï¼š`å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½ç±»çš„ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šå‘ä¸Šå§”æ´¾ã€æœ€åè‡ªæ•‘`ã€‚

> [!NOTE]
>
> * â‘  `å‘ä¸Šå§”æ´¾`ï¼šç±»åŠ è½½å™¨æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šå‘ä¸Šå§”æ‰˜ï¼Œç›´åˆ°é€’å½’åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼›å¦‚æœä¸­é—´æœ‰ä»»æ„ä¸€ä¸ªç±»åŠ è½½å™¨å·²ç»åŠ è½½äº†ï¼Œå°±ç›´æ¥è¿”å›ã€‚
> * â‘¡ `æœ€åè‡ªæ•‘`ï¼šå½“æ‰€æœ‰çš„çˆ¶ç±»åŠ è½½å™¨éƒ½æ— æ³•å®ŒæˆåŠ è½½è¯·æ±‚æ—¶ï¼Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±åŠ è½½ï¼Œå¦‚æœåŠ è½½å¤±è´¥ï¼Œå°±æŠ¥é”™ ClassNotFoundException ã€‚

* æ¯ä¸ª`ç±»åŠ è½½å™¨`éƒ½æœ‰ä¸€ä¸ª `parent` å±æ€§ï¼ŒæŒ‡å‘ä¸Šä¸€çº§çš„ç±»åŠ è½½å™¨ï¼ˆçˆ¶åŠ è½½å™¨ï¼‰ï¼Œå½¢æˆå±‚æ¬¡å…³ç³»ã€‚

![](./assets/125.svg)

* åŒäº²å§”æ´¾æœºåˆ¶çš„æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| æµç¨‹                       | æè¿°                                                         |
| -------------------------- | ------------------------------------------------------------ |
| â‘  å…ˆæŸ¥ç¼“å­˜ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰ | æ”¶åˆ°åŠ è½½è¯·æ±‚æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ JVM æ˜¯å¦å·²å­˜åœ¨è¯¥ç±»çš„ Class å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ |
| â‘¡ å‘ä¸Šå§”æ´¾ï¼ˆé€’å½’åŠ è½½ï¼‰     | ç±»åŠ è½½å™¨ä¸ä¼šè‡ªè¡ŒåŠ è½½ï¼Œè€Œæ˜¯å‘ä¸Šå§”æ‰˜ï¼ˆé€’å½’åŠ è½½ï¼‰ï¼Œç›´åˆ°åˆ°è¾¾å¯åŠ¨ç±»åŠ è½½å™¨ã€‚<br>å¦‚æœä»»æ„å±‚æ¬¡ç±»åŠ è½½å™¨æˆåŠŸåŠ è½½ï¼Œç«‹å³è¿”å› Class å¯¹è±¡ï¼Œä¸å†å‘ä¸Šå§”æ´¾ã€‚<br> |
| â‘¢ æœ€åè‡ªæ•‘                 | åªæœ‰å½“çˆ¶åŠ è½½å™¨æ˜ç¡®æ— æ³•åŠ è½½æ—¶ï¼Œå­åŠ è½½å™¨æ‰å°è¯•è‡ªå·±åŠ è½½ã€‚       |

* å…¶å®ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶çš„æºç éå¸¸ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException {
    // åŠ é”ï¼Œç›®çš„æ˜¯ä¸ºäº†åªè®©ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡ŒåŠ è½½ä»»åŠ¡
    synchronized (getClassLoadingLock(name)) {
        // åˆ¤æ–­æ˜¯å¦åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›
        Class<?> c = findLoadedClass(name);
        if (c == null) {
            // å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½æˆ–å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
            long t0 = System.nanoTime();
            try {
                // å¦‚æœæœ‰çˆ¶ç±»åŠ è½½ï¼Œå°±å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¹¶è¿”å›ï¼ˆé€’å½’ï¼‰
                if (parent != null) {
                    c = parent.loadClass(name, false);
                } else {
                    // å¦‚æœä¸å­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œå°±å§”æ‰˜ç»™å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¹¶è¿”å›
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // ClassNotFoundException thrown if class not found
                // from the non-null parent class loader
            }

            // å¦‚æœåˆ°è¿™é‡Œè¿˜æ˜¯ null ï¼Œå°±è¯´æ˜æ²¡æœ‰ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå°±å°è¯•è‡ªèº«åŠ è½½
            if (c == null) {
                // If still not found, then invoke findClass in order
                // to find the class.
                long t1 = System.nanoTime();
                // è°ƒç”¨è‡ªå·±çš„åŠ è½½åŠŸèƒ½ï¼Œå¹¶è¿”å›
                c = findClass(name);

                // this is the defining class loader; record the stats
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            resolveClass(c);
        }
        return c;
    }
}
```

* åŒäº²å§”æ´¾æœºåˆ¶å¯¹åº”çš„æµç¨‹å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```mermaid
graph TD
    A[åº”ç”¨ä»£ç ] --> B[AppClassLoader]
    B --> C[ExtClassLoader]
    C --> D[Bootstrap]
    
    D -->|â‘  ä¼˜å…ˆå°è¯•| E[rt.jar æ ¸å¿ƒç±»]
    C -->|â‘¡ æ‰©å±•å°è¯•| F[jre/lib/ext]
    B -->|â‘¢ æœ€åå°è¯•| G[classpath åº”ç”¨ç±»]
    
    style D fill:#ffe58f,stroke:#faad14
    style C fill:#ffd777,stroke:#fa8c16
    style B fill:#ffccc7,stroke:#f5222d
```



#### 2.4.3.2 å‘ä¸Šå§”æ‰˜

* æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œåœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨ä¼šæ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½äº†è¯¥ç±»ï¼Ÿ

- [x] å¦‚æœåŠ è½½äº†ï¼Œåˆ™ç›´æ¥è¿”å›ï¼ŒåŠ è½½è¿‡ç¨‹ç»“æŸã€‚
- [x] å¦‚æœæ²¡æœ‰åŠ è½½ï¼Œå°±å°†åŠ è½½ä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚

> [!NOTE]
>
> åªè¦æœ‰ä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½è¿‡è¯¥ç±»ï¼Œå°±å¯ä»¥æ‰¾åˆ°è¯¥ç±»ï¼Œå¹¶ç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤åŠ è½½ï¼ï¼ï¼



* ç¤ºä¾‹ï¼š

![](./assets/127.gif)



* ç¤ºä¾‹ï¼š

![](./assets/128.gif)

#### 2.4.3.3 æœ€åè‡ªæ•‘

* å¦‚æœæ‰€æœ‰çš„çˆ¶ç±»åŠ è½½å™¨éƒ½æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œåˆ™ç”±å½“å‰ç±»åŠ è½½å™¨è‡ªå·±å°è¯•åŠ è½½ï¼Œå³ï¼šæœ€åè‡ªæ•‘ã€‚



* ç¤ºä¾‹ï¼š

![](./assets/129.gif)

#### 2.4.3.4 å°é—®é¢˜

* å¸¸è§çš„é¢è¯•å°é—®é¢˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| é—®é¢˜                                                         | ç­”æ¡ˆ                                                         | å…³é”®çŸ¥è¯†ç‚¹                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------ |
| :one: å¦‚æœä¸€ä¸ªç±»é‡å¤å‡ºç°åœ¨ä¸‰ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„è·¯å¾„ä¸Šï¼Œåº”è¯¥ç”±è°æ¥è¿›è¡ŒåŠ è½½ï¼Ÿ | å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œæ ¹æ®åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå®ƒçš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ã€‚ | åŒäº²å§”æ´¾æœºåˆ¶ã€ç±»åŠ è½½å™¨ä¼˜å…ˆçº§   |
| :two: åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­åˆ›å»º java.lang.String ç±»ï¼Œä¼šè¢«åŠ è½½å—ï¼Ÿ   | ä¸ä¼šï¼Œä¼šè¿”å›å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ rt.jar åŒ…ä¸­çš„ String ç±»ã€‚       | å¯åŠ¨ç±»åŠ è½½å™¨ã€æ ¸å¿ƒç±»åº“ä¿æŠ¤æœºåˆ¶ |

#### 2.4.3.5 å¦‚ä½•åœ¨ä»£ç ä¸­ä¸»åŠ¨åŠ è½½ä¸€ä¸ªç±»

* â‘  ä½¿ç”¨ `Class.forName("ç±»çš„å…¨é™å®šå")`æ–¹æ³•ï¼Œå³ï¼šä½¿ç”¨å½“å‰ç±»çš„ç±»åŠ è½½å™¨å»åŠ è½½æŒ‡å®šçš„ç±»ã€‚

::: code-group

```java [Class.java]
public final class Class<T> implements java.io.Serializable,
                              GenericDeclaration,Type,AnnotatedElement {
    ...                              
    public static Class<?> forName(String className)
                throws ClassNotFoundException {
        Class<?> caller = Reflection.getCallerClass();
        return forName0(className, true, 
                        ClassLoader.getClassLoader(caller), caller);
    }
     
    ...
}
```

```java [Test.java]
public class Test {
    public static void main( String[] args ) throws ClassNotFoundException {
        Class.forName("com.github.domain.Student");
    }
}
```

:::

* â‘¡ é€šè¿‡`ç±»åŠ è½½`å¯¹è±¡çš„ `loadClass("")` æ–¹æ³•å»åŠ è½½æŒ‡å®šçš„ç±»ã€‚

::: code-group

```java [ClassLoader.java]
public abstract class ClassLoader {
    ...
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        return loadClass(name, false);
    }
    ...
}
```

```java [Test.java]
public class Test {
    public static void main( String[] args ) throws ClassNotFoundException {

        ClassLoader classLoader = Test.class.getClassLoader();
        System.out.println("classLoader = " + classLoader);

        Class<?> aClass = classLoader.loadClass("com.github.domain.Student");
        System.out.println("aClass = " + aClass);

    }
}
```

:::

### 2.4.4 çˆ¶ç±»åŠ è½½å™¨ç»†èŠ‚

* æ¯ä¸ª Java å®ç°çš„`ç±»åŠ è½½`ä¸­éƒ½ä¿å­˜äº†ä¸€ä¸ª parent çš„æˆå‘˜å˜é‡ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸Šä¸‹çº§å…³ç³»ã€‚

> [!NOTE]
>
> ç±»åŠ è½½å™¨ä¹‹é—´æ˜¯ç»„åˆå…³ç³»ï¼Œä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼ï¼ï¼

```java
public abstract class ClassLoader {

    ...
        
    private final ClassLoader parent; // çˆ¶
	
    ...
}    
```

* è™½ç„¶æ‰©å±•ç±»åŠ è½½å™¨çš„`parent`æ˜¯`null`ï¼›ä½†æ˜¯ï¼Œä»é€»è¾‘ä¸Šä¾ç„¶è®¤ä¸º`å¯åŠ¨ç±»åŠ è½½å™¨`æ˜¯`æ‰©å±•ç±»åŠ è½½å™¨`çš„`çˆ¶ç±»åŠ è½½å™¨`ã€‚

> [!NOTE]
>
> å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯ä½¿ç”¨ C++ å®ç°çš„ï¼Œæ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼ï¼ï¼

![](./assets/130.svg)

* å¯ä»¥åœ¨`Arthas`ä¸­æŸ¥çœ‹ç±»åŠ è½½å™¨ä¸Šä¸‹çº§å…³ç³»ï¼š

::: code-group

```bash
classloader -t
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/108.gif)
```

:::

### 2.4.5 æ€»ç»“

* åŒäº²å§”æ´¾æœºåˆ¶ï¼š`å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½ç±»çš„ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šå‘ä¸Šå§”æ´¾ã€æœ€åè‡ªæ•‘`ã€‚

> [!NOTE]
>
> * â‘  `å‘ä¸Šå§”æ´¾`ï¼šç±»åŠ è½½å™¨æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šå‘ä¸Šå§”æ‰˜ï¼Œç›´åˆ°é€’å½’åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼›å¦‚æœä¸­é—´æœ‰ä»»æ„ä¸€ä¸ªç±»åŠ è½½å™¨å·²ç»åŠ è½½äº†ï¼Œå°±ç›´æ¥è¿”å›ã€‚
> * â‘¡ `æœ€åè‡ªæ•‘`ï¼šå½“æ‰€æœ‰çš„çˆ¶ç±»åŠ è½½å™¨éƒ½æ— æ³•å®ŒæˆåŠ è½½è¯·æ±‚æ—¶ï¼Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±åŠ è½½ï¼Œå¦‚æœåŠ è½½å¤±è´¥ï¼Œå°±æŠ¥é”™ ClassNotFoundException ã€‚
> * â‘¢ `åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`çš„`çˆ¶ç±»åŠ è½½å™¨`æ˜¯`æ‰©å±•ç±»åŠ è½½å™¨`ï¼Œ`æ‰©å±•ç±»åŠ è½½å™¨`çš„`çˆ¶ç±»åŠ è½½å™¨`æ˜¯`å¯åŠ¨ç±»åŠ è½½å™¨`ã€‚

* åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„ï¼ˆä½œç”¨ï¼‰ï¼š

| å¥½å¤„ï¼ˆä½œç”¨ï¼‰          | æè¿°                                                         |
| --------------------- | ------------------------------------------------------------ |
| â‘   ä¿è¯ç±»åŠ è½½çš„å®‰å…¨æ€§ | é¿å…æ¶æ„ä»£ç æ›¿æ¢ JDK ä¸­çš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚ï¼šjava.lang.Stringï¼Œç¡®ä¿æ ¸å¿ƒç±»åº“çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚ |
| â‘¡ é¿å…é‡å¤åŠ è½½        | åŒäº²å§”æ´¾æœºåˆ¶å¯ä»¥é¿å…åŒä¸€ä¸ªç±»è¢«å¤šæ¬¡åŠ è½½ï¼Œå‡å°‘åŠ è½½è¿‡ç¨‹ä¸­çš„æ€§èƒ½å¼€é”€ã€‚ |

## 2.5 æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶

### 2.5.1 æ¦‚è¿°

* `åŒäº²å§”æ´¾æœºåˆ¶`ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯`ç±»åŠ è½½è¿‡ç¨‹ä¸­æ ¸å¿ƒç±»åº“çš„å®‰å…¨`ä»¥åŠ`é˜²æ­¢ä¸€ä¸ªç±»è¢«é‡å¤åŠ è½½`ã€‚

```mermaid
graph TD
    A[åº”ç”¨ä»£ç ] --> B[AppClassLoader]
    B --> C[ExtClassLoader]
    C --> D[Bootstrap]
    
    D -->|â‘  ä¼˜å…ˆå°è¯•| E[rt.jar æ ¸å¿ƒç±»]
    C -->|â‘¡ æ‰©å±•å°è¯•| F[jre/lib/ext]
    B -->|â‘¢ æœ€åå°è¯•| G[classpath åº”ç”¨ç±»]
    
    style D fill:#ffe58f,stroke:#faad14
    style C fill:#ffd777,stroke:#fa8c16
    style B fill:#ffccc7,stroke:#f5222d
```

* ä½†æ˜¯ï¼Œåœ¨æŸäº›ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦`æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶`ä»¥å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚

### 2.5.2 æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„æ–¹å¼

* æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„é˜²æ­¢ï¼Œä¸»è¦æœ‰ 3 ç§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| æ–¹å¼                      | æè¿°                                                         |
| ------------------------- | ------------------------------------------------------------ |
| â‘  è‡ªå®šä¹‰ç±»åŠ è½½å™¨          | è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¹¶é‡å†™ loadClass() æ–¹æ³•ï¼Œå°±å¯ä»¥å°†åŒäº²å§”æ´¾çš„æœºåˆ¶ä¸­çš„ä»£ç å»é™¤ã€‚<br>Tomcat å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼å®ç°åº”ç”¨ä¹‹é—´ç±»çš„éš”ç¦»ã€‚ |
| â‘¡ çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨      | åˆ©ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½æŒ‡å®šçš„ç±»ï¼Œå¦‚ï¼šJDBC å’Œ JNDI ç­‰ã€‚    |
| ~~â‘¢ OSGI æ¡†æ¶çš„ç±»åŠ è½½å™¨~~ | å†å²ä¸Š OSGI æ¡†æ¶å®ç°äº†ä¸€å¥—æ–°çš„ç±»åŠ è½½å™¨æœºåˆ¶ï¼Œå…è®¸åŒçº§ä¹‹é—´å§”æ‰˜è¿›è¡Œç±»çš„åŠ è½½ã€‚ |

### 2.5.3 è‡ªå®šä¹‰ç±»åŠ è½½å™¨

#### 2.5.3.1 æ¦‚è¿°

* Tomcat ç¨‹åºæ˜¯å¯ä»¥è¿è¡Œå¤šä¸ª WEB åº”ç”¨çš„ï¼Œå¦‚æœè¿™ä¸¤ä¸ªåº”ç”¨ä¸­å‡ºç°äº†ç›¸åŒé™å®šåçš„ç±»ï¼Œå¦‚ï¼š`com.github.HelloServlet` ï¼ŒTomcat éœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»éƒ½èƒ½è¢«åŠ è½½ã€‚

![](./assets/131.svg)

* å¦‚æœä¸æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå½“åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½`åº”ç”¨1`ä¸­çš„`Servlet`ä¹‹åï¼Œ`åº”ç”¨2`ä¸­`ç›¸åŒé™å®šå`çš„`Servlet`å°±æ— æ³•è¢«åŠ è½½ã€‚

![](./assets/132.svg)

* Tomcat ä½¿ç”¨äº†`è‡ªå®šä¹‰ç±»åŠ è½½å™¨`æ¥è§£å†³åº”ç”¨ä¹‹é—´ç±»çš„éš”ç¦»ï¼Œå³ï¼šæ¯ä¸ªåº”ç”¨éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åŠ è½½å™¨æ¥åŠ è½½å¯¹åº”çš„ç±»ã€‚

![](./assets/133.svg)

#### 2.5.3.2 è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç›¸å…³æ–¹æ³•

* è‡ªå®šä¹‰ç±»åŠ è½½çš„æ ¸å¿ƒé€»è¾‘åœ¨ ClasssLoader ç±»ä¸­çš„ loadClass æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public Class<?> loadClass(String name) throws ClassNotFoundException {
    return loadClass(name, false);
}

protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException {
    // åŠ é”ï¼Œç›®çš„æ˜¯ä¸ºäº†åªè®©ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡ŒåŠ è½½ä»»åŠ¡
    synchronized (getClassLoadingLock(name)) {
        // åˆ¤æ–­æ˜¯å¦åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›
        Class<?> c = findLoadedClass(name);
        if (c == null) {
            // å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½æˆ–å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
            long t0 = System.nanoTime();
            try {
                // å¦‚æœæœ‰çˆ¶ç±»åŠ è½½ï¼Œå°±å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¹¶è¿”å›ï¼ˆé€’å½’ï¼‰
                if (parent != null) {
                    c = parent.loadClass(name, false);
                } else {
                    // å¦‚æœä¸å­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œå°±å§”æ‰˜ç»™å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¹¶è¿”å›
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // ClassNotFoundException thrown if class not found
                // from the non-null parent class loader
            }

            // å¦‚æœåˆ°è¿™é‡Œè¿˜æ˜¯ null ï¼Œå°±è¯´æ˜æ²¡æœ‰ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå°±å°è¯•è‡ªèº«åŠ è½½
            if (c == null) {
                // If still not found, then invoke findClass in order
                // to find the class.
                long t1 = System.nanoTime();
                // è°ƒç”¨è‡ªå·±çš„åŠ è½½åŠŸèƒ½ï¼Œå¹¶è¿”å›
                c = findClass(name);

                // this is the defining class loader; record the stats
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            // é“¾æ¥åŠŸèƒ½
            resolveClass(c);
        }
        return c;
    }
}
```

* å…¶å®ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹çš„å››ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// ç±»åŠ è½½å™¨çš„å…¥å£ï¼Œå†…éƒ¨å®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚
// å¦‚æœçˆ¶ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½ï¼Œå°±ä¼šè‡ªæ•‘ï¼Œå³ï¼šè°ƒç”¨äº†findClass()æ–¹æ³•ï¼ŒåŠ è½½classpathä¸Šçš„ç±»
public Class<?> loadClass(String name) throws ClassNotFoundException {
    return loadClass(name, false);
}
```

```java
// æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œç”±ç±»åŠ è½½å™¨çš„å­ç±»å®ç°
// å› ä¸ºæ‰©å±•ç±»åŠ è½½å™¨å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨éƒ½æ˜¯ URLClassLoader çš„å­ç±»ï¼Œ
// æ‰€ä»¥ URLClassader å°±å®ç°äº†è¯¥é€»è¾‘ï¼Œå³ï¼šæ ¹æ®æ–‡ä»¶è·¯å¾„å»è·å–ç±»æ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶æ•°æ®
// å†…éƒ¨ä¼šè°ƒç”¨ defineClass() æ–¹æ³•
protected Class<?> findClass(String name) throws ClassNotFoundException {
    throw new ClassNotFoundException(name);
}
```

```java
// å…¶ç›®çš„æ˜¯åœ¨åšä¸€äº›ç±»çš„æ ¡éªŒåŠŸèƒ½ï¼Œå¹¶åœ¨å †å’Œæ–¹æ³•åŒºåˆ›å»ºå¯¹åº”çš„åŒ…å«ç±»ä¿¡æ¯çš„å¯¹è±¡
// å †ä¸Šåˆ›å»ºçš„å°±æ˜¯ Class å¯¹è±¡ã€‚
// æ–¹æ³•åŒºåˆ›å»ºçš„æ˜¯ KlassInstance å¯¹è±¡ï¼Œä»¥ä¾¿å®ç°å¤šæ€ç­‰åŠŸèƒ½ã€‚
private Class<?> defineClass(String name, Resource res) throws IOException {
    long t0 = System.nanoTime();
    int i = name.lastIndexOf('.');
    URL url = res.getCodeSourceURL();
    if (i != -1) {
        String pkgname = name.substring(0, i);
        // Check if package already loaded.
        Manifest man = res.getManifest();
        definePackageInternal(pkgname, man, url);
    }
    // Now read the class bytes and define the class
    java.nio.ByteBuffer bb = res.getByteBuffer();
    if (bb != null) {
        // Use (direct) ByteBuffer:
        CodeSigner[] signers = res.getCodeSigners();
        CodeSource cs = new CodeSource(url, signers);
        sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);
        return defineClass(name, bb, cs);
    } else {
        byte[] b = res.getBytes();
        // must read certificates AFTER reading bytes.
        CodeSigner[] signers = res.getCodeSigners();
        CodeSource cs = new CodeSource(url, signers);
        sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);
        return defineClass(name, b, 0, b.length, cs);
    }
}
```

```java
// æ‰§è¡Œç±»ç”Ÿå‘½å‘¨æœŸçš„é“¾æ¥åŠŸèƒ½
protected final void resolveClass(Class<?> c) {
    resolveClass0(c);
}
```

#### 2.5.3.3 è‡ªå®šä¹‰ç±»åŠ è½½å™¨

* è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¾ˆç®€å•ï¼Œåªéœ€è¦é‡å†™ loadClass() æ–¹æ³•æˆ– findClass() æ–¹æ³•ã€‚

> [!NOTE]
>
> åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ›´æ¨èé‡å†™ findClass() æ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·ä¸ä¼šæ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚



* ç¤ºä¾‹ï¼š

::: code-group

```java [Student.java]
package com.github.domain;

public class Student {

    static {
        System.out.println("Student åŠ è½½äº†...");
    }

    public Student() {
        System.out.println("Student åˆ›å»ºäº†...");
    }
}
```

```java [BreakClassLoader.java]
package com.github.loader;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;

public class BreakClassLoader extends ClassLoader {

    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        if (name.startsWith("java")) {
            return super.loadClass(name);
        }
        try {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è¯¥ç±»
            Class<?> clazz = findLoadedClass(name);

            if (clazz != null) {
                return clazz;
            }
            
            // è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
            String classPath = name.replace(".", "/") + ".class";
            try (InputStream is = getResourceAsStream(classPath)) {
                if (is == null) {
                    return super.loadClass(name);
                }

                // æ‰‹åŠ¨è¯»å–å­—èŠ‚æµ
                ByteArrayOutputStream bos = new ByteArrayOutputStream();
                byte[] buffer = new byte[1024];
                int len;
                while ((len = is.read(buffer)) != -1) {
                    bos.write(buffer, 0, len);
                }
                byte[] classBytes = bos.toByteArray();

                // å®šä¹‰å¹¶è¿”å›ç±»
                return defineClass(name, classBytes, 0, classBytes.length);
            }
        } catch (Exception e) {
            throw new ClassNotFoundException("Failed to load class: " + name, e);
        }
    }
}
```

```java [Test.java]
package com.github;

import com.github.loader.BreakClassLoader;

public class Test {
    public static void main( String[] args ) throws Exception {

        BreakClassLoader breakClassLoader = new BreakClassLoader();

        Class<?> aClass = breakClassLoader.loadClass("com.github.domain.Student");
        System.out.println("aClass = " + aClass.getClassLoader());

        Object o = aClass.newInstance();
        System.out.println("o = " + o);

    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/134.gif)
```

:::

#### 2.5.3.4 è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

* é»˜è®¤æƒ…å†µä¸‹ï¼Œ`è‡ªå®šä¹‰ç±»åŠ è½½å™¨`çš„`çˆ¶ç±»åŠ è½½å™¨`æ˜¯`åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`ã€‚

```mermaid
graph TD
    A[å¯åŠ¨ç±»åŠ è½½å™¨<br/>Bootstrap ClassLoader<br/>è™šæ‹Ÿæœºåº•å±‚å®ç°] --> B[æ‰©å±•ç±»åŠ è½½å™¨<br/>Extension ClassLoader<br/>Javaè¯­è¨€å®ç°]
    B --> C[åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨<br/>Application ClassLoader<br/>ç³»ç»Ÿç±»åŠ è½½å™¨<br/>Javaè¯­è¨€å®ç°]
    C --> D[è‡ªå®šä¹‰ç±»åŠ è½½å™¨1<br/>Custom ClassLoader 1<br/>Javaè¯­è¨€å®ç°]
    C --> E[è‡ªå®šä¹‰ç±»åŠ è½½å™¨2<br/>Custom ClassLoader 2<br/>Javaè¯­è¨€å®ç°]
    C --> F[è‡ªå®šä¹‰ç±»åŠ è½½å™¨N<br/>Custom ClassLoader N<br/>Javaè¯­è¨€å®ç°]
    
    %% åŠ è½½å†…å®¹è¯´æ˜
    A1[æ ¸å¿ƒç±»åº“<br/>java.lang.*<br/>java.util.*<br/>$JAVA_HOME/jre/lib] -.-> A
    B1[æ‰©å±•ç±»åº“<br/>$JAVA_HOME/jre/lib/ext<br/>java.ext.dirsè·¯å¾„] -.-> B
    C1[åº”ç”¨ç¨‹åºç±»<br/>classpathè·¯å¾„<br/>ç”¨æˆ·è‡ªå®šä¹‰ç±»] -.-> C
    D1[ç½‘ç»œåŠ è½½<br/>æ•°æ®åº“åŠ è½½<br/>åŠ å¯†è§£å¯†<br/>çƒ­éƒ¨ç½²] -.-> D
    
    %% æ ·å¼å®šä¹‰
    classDef bootstrap fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef extension fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef application fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef custom fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef content fill:#f5f5f5,stroke:#616161,stroke-width:1px,stroke-dasharray: 5 5
    
    class A bootstrap
    class B extension
    class C application
    class D,E,F custom
    class A1,B1,C1,D1 content
```

* ä»¥ JDK8 ä¸ºä¾‹ï¼ŒClassLoader ä¸­æä¾›äº†é»˜è®¤çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå†…éƒ¨å°±è®¾ç½®äº† parent çš„å€¼ï¼š

```java
protected ClassLoader() {
    // getSystemClassLoader() é»˜è®¤å°±æ˜¯ ApplicationClassLoader
    this(checkCreateClassLoader(), getSystemClassLoader());
}

private ClassLoader(Void unused, ClassLoader parent) {
    this.parent = parent;
    if (ParallelLoaders.isRegistered(this.getClass())) {
        parallelLockMap = new ConcurrentHashMap<>();
        package2certs = new ConcurrentHashMap<>();
        domains =
            Collections.synchronizedSet(new HashSet<ProtectionDomain>());
        assertionLock = new Object();
    } else {
        // no finer-grained lock; lock on the classloader instance
        parallelLockMap = null;
        package2certs = new Hashtable<>();
        domains = new HashSet<>();
        assertionLock = this;
    }
}
```

* å¦‚æœæƒ³è¦è‡ªå·±è®¾ç½®`è‡ªå®šä¹‰ç±»åŠ è½½å™¨`çš„`çˆ¶ç±»åŠ è½½å™¨`ï¼Œåªéœ€è¦è‡ªå·±é‡å†™æœ‰å‚æ„é€ æ–¹æ³•å³å¯ï¼š

```java
package com.github.loader;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;

public class BreakClassLoader extends ClassLoader {

    public BreakClassLoader(ClassLoader parent) { // [!code highlight:3]
        super(parent); 
    }

    public BreakClassLoader() { // [!code highlight:3]
        // è®¾ç½®çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨
        super(ClassLoader.getSystemClassLoader().getParent());
    }

    ...

}
```

#### 2.5.3.5 ç»†èŠ‚

* ã€é—®ã€‘ä¸¤ä¸ª`è‡ªå®šä¹‰ç±»åŠ è½½å™¨`åŠ è½½`ç›¸åŒé™å®šå`çš„ç±»ï¼Œä¼šå†²çªï¼Ÿ

> [!NOTE]
>
> ä¸ä¼šå†²çªï¼Œåœ¨åŒä¸€ä¸ª JVM ä¸­ï¼Œåªæœ‰`ç›¸åŒç±»åŠ è½½å™¨+ç›¸åŒé™å®šåçš„ç±»`æ‰ä¼šè¢«è®¤å®šä¸ºä¸€ä¸ªåŒä¸€ä¸ªç±»ã€‚



* ç¤ºä¾‹ï¼š

::: code-group

```java [Student.java]
package com.github.domain;

public class Student {

    static {
        System.out.println("Student åŠ è½½äº†...");
    }

    public Student() {
        System.out.println("Student åˆ›å»ºäº†...");
    }
}
```

```java [BreakClassLoader.java]
package com.github.loader;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;

public class BreakClassLoader extends ClassLoader {

    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // å¯¹äºç³»ç»Ÿç±»ï¼Œä»ç„¶ä½¿ç”¨åŒäº²å§”æ´¾
        if (name.startsWith("java.") || name.startsWith("javax.") || name.startsWith("sun.")) {
            return super.loadClass(name);
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
        Class<?> clazz = findLoadedClass(name);
        if (clazz != null) {
            return clazz;
        }

        // ç›´æ¥è°ƒç”¨è‡ªå·±çš„findClassï¼Œæ‰“ç ´åŒäº²å§”æ´¾
        return findClass(name);
    }

    @Override
    public Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            // è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
            String classPath = name.replace(".", "/") + ".class";
            try (InputStream is = getResourceAsStream(classPath)) {
                if (is == null) {
                    return super.loadClass(name);
                }

                // æ‰‹åŠ¨è¯»å–å­—èŠ‚æµ
                ByteArrayOutputStream bos = new ByteArrayOutputStream();
                byte[] buffer = new byte[1024];
                int len;
                while ((len = is.read(buffer)) != -1) {
                    bos.write(buffer, 0, len);
                }
                byte[] classBytes = bos.toByteArray();

                // å®šä¹‰å¹¶è¿”å›ç±»
                return defineClass(name, classBytes, 0, classBytes.length);
            }
        } catch (Exception e) {
            throw new ClassNotFoundException("Failed to load class: " + name, e);
        }
    }
}
```

```java [Test.java]
package com.github;

import com.github.loader.BreakClassLoader;


public class Test {
    public static void main( String[] args ) throws Exception {

        BreakClassLoader breakClassLoader = new BreakClassLoader();

        Class<?> aClass = breakClassLoader.loadClass("com.github.domain.Student");
        System.out.println("aClass = " + aClass.getClassLoader());

        BreakClassLoader breakClassLoader2 = new BreakClassLoader();

        Class<?> aClass2 = breakClassLoader2.loadClass("com.github.domain.Student");
        System.out.println("aClass2 = " + aClass2.getClassLoader());

        System.out.println(aClass == aClass2); // false

    }
}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/135.gif)
```

:::



* ç¤ºä¾‹ï¼š

::: code-group

```bash
sc -d com.github.domain.Student
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/136.gif)
```

:::

#### 2.5.3.6 ç»†èŠ‚

* è‡ªå®šä¹‰ç±»åŠ è½½å™¨åº”è¯¥é‡å†™ `findClass` æ–¹æ³•è€Œä¸æ˜¯ `loadClass` æ–¹æ³•ï¼Œæœ‰å¦‚ä¸‹çš„å¥½å¤„ï¼š

| é‡å†™ `findClass` æ–¹æ³•çš„å¥½å¤„ | æè¿°                                                         |
| --------------------------- | ------------------------------------------------------------ |
| â‘  ä¿æŒåŒäº²å§”æ´¾æœºåˆ¶          | `loadClass` æ–¹æ³•ä¼šå…ˆå§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨                         |
| â‘¡ å®ç°è‡ªå®šä¹‰åŠ è½½é€»è¾‘        | åœ¨ `findClass` ä¸­å®ç°ä»ä¸åŒæ¸ é“ï¼ˆç½‘ç»œã€æ•°æ®åº“ã€åŠ å¯†æ–‡ä»¶ç­‰ï¼‰åŠ è½½å­—èŠ‚ç  |
| â‘¢ é¿å…ç ´åç±»åŠ è½½é¡ºåº        | ç¡®ä¿ç³»ç»Ÿç±»å’Œåº”ç”¨ç±»çš„åŠ è½½ä¼˜å…ˆçº§                               |



* ç¤ºä¾‹ï¼š

```java
public class CustomClassLoader extends ClassLoader {

    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            // å¯ä»¥ä»ä»»ä½•åœ°æ–¹è·å–å­—èŠ‚ç 
            byte[] classData = getClassDataFromCustomSource(name);

            // å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º Class å¯¹è±¡
            return defineClass(name, classData, 0, classData.length);
        } catch (Exception e) {
            throw new ClassNotFoundException(name);
        }
    }

    private byte[] getClassDataFromCustomSource(String className) {
        // è¿™é‡Œå¯ä»¥å®ç°å„ç§è·å–å­—èŠ‚ç çš„æ–¹å¼ï¼š
        // 1. ä»æ•°æ®åº“è¯»å–
        // 2. ä»åŠ å¯†æ–‡ä»¶è§£å¯†è·å–
        // 3. é€šè¿‡ HTTP è¯·æ±‚è·å–
        // 4. ä»å†…å­˜ä¸­çš„å­—èŠ‚æ•°ç»„è·å–
        return new byte[0]; 
    }
}
```

### 2.5.4 SPI æœºåˆ¶

#### 2.5.4.1 æ¦‚è¿°

* SPIï¼ˆService Provider Interfaceï¼‰æ˜¯ JDK å†…ç½®çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä¸»è¦ç”¨äºå¯æ’æ‹”çš„ç»„ä»¶æ¶æ„ã€‚
* SPI æœºåˆ¶å…è®¸ç¬¬ä¸‰æ–¹ä¸ºæŸä¸ªæ¥å£æä¾›å®ç°ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå³ï¼šå°†æ¥å£çš„`å®šä¹‰`å’Œ`å…·ä½“å®ç°`åˆ†ç¦»ã€‚

#### 2.5.4.2 APIï¼ˆåº”ç”¨ç¨‹åºæ¥å£ï¼‰ 

* APIï¼ˆApplication Programming Interfaceï¼‰æ˜¯ä¸€ç§åº”ç”¨ç¨‹åºæ¥å£ï¼Œå®ƒå®šä¹‰äº†è½¯ä»¶ç»„ä»¶ä¹‹é—´å¦‚ä½•ç›¸äº’äº¤äº’ï¼Œå®ƒè§„å®šäº†è°ƒç”¨æ–¹å¼ã€æ•°æ®æ ¼å¼ã€è¿”å›ç»“æœç­‰ã€‚
* API ä¸»è¦ç”¨äºæä¾›ä¸€ç§ä¸ç‰¹å®šè½¯ä»¶ç»„ä»¶æˆ–æœåŠ¡è¿›è¡Œäº¤äº’çš„æŠ½è±¡å±‚ï¼Œå¦‚ï¼šJDK ä¸­æä¾›çš„å„ç§ API ä»¥åŠå„ç§ SDK ä¸­çš„ API ã€‚
* API çš„ç‰¹ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| ç‰¹ç‚¹             | æè¿°                                                         |
| ---------------- | ------------------------------------------------------------ |
| :one: è®¾è®¡ç›®æ ‡   | API æä¾›è€…å°†åŠŸèƒ½å®ç°å¥½ï¼ŒAPI è°ƒç”¨è€…åªéœ€è¦å¯¼å…¥ APIï¼Œè°ƒç”¨ API å³å¯å®ŒæˆåŠŸèƒ½ã€‚ |
| :two: ä¾èµ–å…³ç³»   | è°ƒç”¨è€…ä¾èµ–æä¾›è€…ã€‚                                           |
| :three: ä½¿ç”¨æ–¹å¼ | ä¸»åŠ¨è°ƒç”¨ã€‚                                                   |
| :four: å…¸å‹åœºæ™¯  | REST APIã€JDK API ã€SDK API ã€‚                               |

* API çš„å…·ä½“æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/137.svg)

#### 2.5.4.3 SPIï¼ˆæœåŠ¡æä¾›è€…æ¥å£ï¼‰

* SPI æ˜¯æœåŠ¡æä¾›è€…æ¥å£ï¼Œæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä¸ºæŸä¸ªæ¥å£æä¾›å…·ä½“å®ç°ã€‚

* SPI çš„ç‰¹ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| ç‰¹ç‚¹             | æè¿°                                                         |
| ---------------- | ------------------------------------------------------------ |
| :one: è®¾è®¡ç›®æ ‡   | æ¡†æ¶è°ƒç”¨ SPI ï¼Œä»¥ä¾¿å¯ä»¥è°ƒç”¨å®ç°è€…å®ç°çš„æ–¹æ³•ï¼Œå³ï¼šå®ç°è€…å¯ä»¥å¯¹æ¡†æ¶è¿›è¡Œæ‰©å±•ã€‚ |
| :two: ä¾èµ–å…³ç³»   | æ¡†æ¶ä¾èµ–å®ç°è€…ã€‚                                             |
| :three: ä½¿ç”¨æ–¹å¼ | è¢«åŠ¨å‘ç°ã€‚                                                   |
| :four: å…¸å‹åœºæ™¯  | æ’ä»¶ç³»ç»Ÿã€é©±åŠ¨åŠ è½½ï¼Œå¦‚ï¼šJDBC ã€æ—¥å¿—æ¡†æ¶ç­‰ã€‚                  |

* SPI çš„å…·ä½“æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](./assets/138.svg)

#### 2.5.4.4  SPI æ¼”ç¤º

* SPI çš„åŸç†å°±æ˜¯`å°†æ¥å£çš„å®ç°ç±»æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è¯»å–é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡åå°„åŠ è½½å®ç°ç±»`ã€‚
* å…¶å…·ä½“çš„æµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| æµç¨‹                 | æè¿°                                                         |
| -------------------- | ------------------------------------------------------------ |
| :one: å®šä¹‰æœåŠ¡æ¥å£   | åˆ›å»ºä¸€ä¸ªæœåŠ¡æ¥å£ã€‚                                           |
| :two: æä¾›å…·ä½“å®ç°   | ä¸åŒçš„å‚å•†æˆ–å¼€å‘è€…æä¾›è¯¥æ¥å£çš„å…·ä½“å®ç°ã€‚                     |
| :three: é…ç½®æ–‡ä»¶å£°æ˜ | åœ¨ `META-INF/services/` ç›®å½•ä¸‹åˆ›å»ºä»¥`æ¥å£å…¨é™å®šå`å‘½åçš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯å®ç°ç±»çš„å…¨é™å®šåã€‚ |
| :four: è¿è¡Œæ—¶å‘ç°    | ä½¿ç”¨ `ServiceLoader` åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å®ç°ç±»ã€‚                |



* ç¤ºä¾‹ï¼šé¡¹ç›®ç»“æ„ä»¥åŠç¯å¢ƒæ­å»º

::: code-group

```md:img [é¡¹ç›®ç»“æ„]
![](./assets/139.png)
```

```xml [Maven(spi-demo ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.github</groupId>
    <artifactId>spi-demo</artifactId>
    <version>1.0</version>
    <packaging>pom</packaging>

    <modules>
        <module>spi-api</module>
        <module>spi-test</module>
        <module>spi-provider</module>
    </modules>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.build.targetEncoding>UTF-8</project.build.targetEncoding>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.github</groupId>
                <artifactId>spi-api</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>com.github</groupId>
                <artifactId>spi-provider-email</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>com.github</groupId>
                <artifactId>spi-provider-sms</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>com.github</groupId>
                <artifactId>spi-provider-wechat</artifactId>
                <version>${project.version}</version>
            </dependency>
            <!-- è‡ªåŠ¨ç”Ÿæˆ SPI é…ç½®æ–‡ä»¶ -->
            <dependency>
                <groupId>com.google.auto.service</groupId>
                <artifactId>auto-service</artifactId>
                <version>1.1.1</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <!--ç¼–è¯‘æ’ä»¶-->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <!--æ’ä»¶åç§°-->
                <artifactId>maven-compiler-plugin</artifactId>
                <!--æ’ä»¶ç‰ˆæœ¬-->
                <version>3.14.0</version>
                <!--æ’ä»¶é…ç½®ä¿¡æ¯-->
                <configuration>
                    <!--ç¼–è¯‘ç¯å¢ƒ JDK ç‰ˆæœ¬-->
                    <source>${maven.compiler.source}</source>
                    <!--è¿è¡Œç¯å¢ƒ JDK ç‰ˆæœ¬-->
                    <target>${maven.compiler.target}</target>
                    <!--ç¼–ç æ ¼å¼-->
                    <encoding>${project.build.sourceEncoding}</encoding>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

:::



* ç¤ºä¾‹ï¼šSPI æ¥å£ä»¥åŠç®¡ç†å™¨ï¼ˆä½¿ç”¨æœåŠ¡å‘ç°ï¼Œå®Œæˆé€šç”¨åŠŸèƒ½ï¼‰

::: code-group

```xml [Maven(spi-api ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.github</groupId>
        <artifactId>spi-demo</artifactId>
        <version>1.0</version>
    </parent>

    <artifactId>spi-api</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

</project>
```

```java [MessageProvider.java]
package com.github.message;

/**
 * SPI æ¥å£ï¼šæ¶ˆæ¯æä¾›è€…ï¼Œæä¾›è€…å®ç°ç±»éœ€è¦å®ç°æ­¤æ¥å£
 */
public interface MessageProvider {

    /**
     * å‘é€æ¶ˆæ¯
     *
     * @param to      æ¥æ”¶è€…
     * @param message æ¶ˆæ¯å†…å®¹
     */
    void sendMessage(String to, String message);

    /**
     * æ£€æŸ¥æ˜¯å¦æ”¯æŒæŒ‡å®šçš„æ¶ˆæ¯
     *
     * @param to æ¥æ”¶è€…ï¼ˆé‚®ç®±ã€æ‰‹æœºå·ã€å¾®ä¿¡å·ï¼‰
     * @return æ˜¯å¦æ”¯æŒ
     */
    Boolean supports(String to);

}
```

```java [MessageManager.java]
package com.github.message;

import java.util.ArrayList;
import java.util.List;
import java.util.ServiceLoader;

/**
 * æ¶ˆæ¯ç®¡ç†å™¨ï¼Œè·å–æ‰€æœ‰æ¶ˆæ¯æä¾›è€…ï¼Œå¹¶è°ƒç”¨æä¾›è€…çš„æ–¹æ³•
 */
public class MessageManager {

    private static final List<MessageProvider> messageProviderList = new ArrayList<>();

    static {
        ServiceLoader<MessageProvider> loader = ServiceLoader.load(MessageProvider.class);
        loader.forEach(messageProviderList::add);
    }

    /**
     * æ ¹æ®æ¥æ”¶è€…æ™ºèƒ½å‘é€æ¶ˆæ¯
     *
     * @param to      æ¥æ”¶è€…
     * @param message æ¶ˆæ¯å†…å®¹
     */
    public static void sendSmartMessage(String to, String message) {
        for (MessageProvider messageProvider : messageProviderList) {
            if (messageProvider.supports(to)) {
                messageProvider.sendMessage(to, message);
            }
        }
    }

}
```

:::



* ç¤ºä¾‹ï¼šSPI æä¾›å•†ï¼ˆSPI æ¥å£çš„å®ç°è€…ï¼‰æ€»é…ç½®

::: code-group

```xml [Maven(spi-provider ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.github</groupId>
        <artifactId>spi-demo</artifactId>
        <version>1.0</version>
    </parent>

    <artifactId>spi-provider</artifactId>
    <packaging>pom</packaging>

    <modules>
        <module>spi-provider-email</module>
        <module>spi-provider-sms</module>
        <module>spi-provider-wechat</module>
    </modules>

</project>
```

:::



* ç¤ºä¾‹ï¼šSPI æä¾›å•†ä¹‹é‚®ä»¶

::: code-group

```xml [Maven(spi-provider-email ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.github</groupId>
        <artifactId>spi-provider</artifactId>
        <version>1.0</version>
    </parent>

    <artifactId>spi-provider-email</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-api</artifactId>
        </dependency>
        <!-- è‡ªåŠ¨ç”Ÿæˆ SPI é…ç½®æ–‡ä»¶ -->
        <dependency>
            <groupId>com.google.auto.service</groupId>
            <artifactId>auto-service</artifactId>
        </dependency>
    </dependencies>

</project>
```

```java [EmailMessageProvider.java]
package com.github.message;

public class EmailMessageProvider implements MessageProvider {
    @Override
    public void sendMessage(String to, String message) {
        System.out.println();
        System.out.println("====== å‘é€é‚®ä»¶å¼€å§‹ ======");
        System.out.println("æ¥æ”¶è€…ï¼š" + to);
        System.out.println("æ¶ˆæ¯å†…å®¹ï¼š" + message);
        System.out.println("====== å‘é€é‚®ä»¶ç»“æŸ ======");
    }

    @Override
    public Boolean supports(String to) {
        // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æ”¯æŒé‚®ç®±
        return to.matches("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$");
    }
}
```

```txt [META-INF/services/com.github.mesage.MesageProvider]
com.github.message.EmailMessageProvider
```

:::



* ç¤ºä¾‹ï¼šSPI æä¾›å•†ä¹‹çŸ­ä¿¡

::: code-group

```xml [Maven(spi-provider-sms ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.github</groupId>
        <artifactId>spi-provider</artifactId>
        <version>1.0</version>
    </parent>

    <artifactId>spi-provider-sms</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.google.auto.service</groupId>
            <artifactId>auto-service</artifactId>
        </dependency>
    </dependencies>

</project>
```

```java [SmsMessageProvider.java]
package com.github.message;

public class SmsMessageProvider implements MessageProvider {
    @Override
    public void sendMessage(String to, String message) {
        System.out.println();
        System.out.println("====== å‘é€çŸ­ä¿¡å¼€å§‹ ======");
        System.out.println("æ¥æ”¶è€…ï¼š" + to);
        System.out.println("æ¶ˆæ¯å†…å®¹ï¼š" + message);
        System.out.println("====== å‘é€çŸ­ä¿¡ç»“æŸ ======");
    }

    @Override
    public Boolean supports(String to) {
        return to.matches("^1(3\\d|4[5-9]|5[0-35-9]|6[2567]|7[0-8]|8\\d|9[0-35-9])\\d{8}$");
    }
}
```

```txt [META-INF/services/com.github.mesage.MesageProvider]
com.github.message.SmsMessageProvider
```

:::



* ç¤ºä¾‹ï¼šSPI æä¾›å•†ä¹‹å¾®ä¿¡

::: code-group

```xml [Maven(spi-provider-wechat ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.github</groupId>
        <artifactId>spi-provider</artifactId>
        <version>1.0</version>
    </parent>

    <artifactId>spi-provider-wechat</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.google.auto.service</groupId>
            <artifactId>auto-service</artifactId>
        </dependency>
    </dependencies>

</project>
```

```java [WeChatMessageProvider.java]
package com.github.message;

public class WeChatMessageProvider implements MessageProvider {
    @Override
    public void sendMessage(String to, String message) {
        System.out.println();
        System.out.println("====== å‘é€å¾®ä¿¡æ¶ˆæ¯å¼€å§‹ ======");
        System.out.println("æ¥æ”¶è€…ï¼š" + to);
        System.out.println("æ¶ˆæ¯å†…å®¹ï¼š" + message);
        System.out.println("====== å‘é€å¾®ä¿¡æ¶ˆæ¯ç»“æŸ ======");
    }

    @Override
    public Boolean supports(String to) {
        return to.matches("^[a-zA-Z][a-zA-Z0-9_-]{5,19}$");
    }
}
```

```txt [META-INF/services/com.github.mesage.MesageProvider]
com.github.message.WeChatMessageProvider
```

:::



* ç¤ºä¾‹ï¼šå®¢æˆ·ç«¯ï¼ˆç”¨æˆ·ï¼‰

::: code-group

```xml [Maven(spi-test ä¸­çš„ pom.xml)]
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.github</groupId>
        <artifactId>spi-demo</artifactId>
        <version>1.0</version>
    </parent>

    <artifactId>spi-test</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-provider-email</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-provider-sms</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github</groupId>
            <artifactId>spi-provider-wechat</artifactId>
        </dependency>
    </dependencies>

</project>
```

```java [Application.java]
package com.github.mesage;

import com.github.message.MessageManager;

public class Application {
    public static void main(String[] args) {
        MessageManager.sendSmartMessage("123@qq.com", "ä½ å¥½");

        MessageManager.sendSmartMessage("13479814595", "ä½ å¥½");

        MessageManager.sendSmartMessage("zhangsan", "ä½ å¥½");
    }
}
```

:::

#### 2.5.4.5 ç®€åŒ– SPI

* ä¹‹å‰ï¼Œæ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨æ–°å»º`META-INF/services/xxx`æ–‡ä»¶å¾ˆéº»çƒ¦ï¼Œå¯ä»¥ä½¿ç”¨ Google æä¾›çš„`AutoService`æ¥ç®€åŒ–ä»£ç ã€‚

```xml
<dependency>
    <groupId>com.google.auto.service</groupId>
    <artifactId>auto-service</artifactId>
    <version>1.1.1</version>
</dependency>
```

* `AutoService` ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆ SPI æ¸…å•æ–‡ä»¶çš„æ¡†æ¶ï¼Œå…¶åŸç†å¾ˆç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  * â‘  éå†æ‰¾åˆ°æ‰€æœ‰å¸¦æœ‰ AutoService æ³¨è§£çš„ç±»ã€‚
  * â‘¡ éªŒè¯ AutoService æ³¨è§£çš„å€¼æ˜¯å¦æ­£ç¡®ã€‚
  * â‘¢ éå†æ‰€æœ‰çš„ä¸‹æ²‰æ¥å£ã€‚
  * â‘£ åœ¨ META-INF/services/ è·¯å¾„ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶åä»¥ç±»çš„æ¥å£ç±»å…¨è·¯å¾„å‘½åã€‚
  * â‘¤ åœ¨æ–‡ä»¶é‡Œå†™å…¥å†…å®¹ï¼Œå®ç°ç±»ï¼ˆå½“å‰æ³¨è§£ç±»ï¼‰çš„å…¨è·¯å¾„ã€‚



* ç¤ºä¾‹ï¼š

::: code-group

```java [EmailMessageProvider.java]
package com.github.message;

import com.google.auto.service.AutoService;

@AutoService(MessageProvider.class)
public class EmailMessageProvider implements MessageProvider {
    @Override
    public void sendMessage(String to, String message) {
        System.out.println();
        System.out.println("====== å‘é€é‚®ä»¶å¼€å§‹ ======");
        System.out.println("æ¥æ”¶è€…ï¼š" + to);
        System.out.println("æ¶ˆæ¯å†…å®¹ï¼š" + message);
        System.out.println("====== å‘é€é‚®ä»¶ç»“æŸ ======");
    }

    @Override
    public Boolean supports(String to) {
        // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æ”¯æŒé‚®ç®±
        return to.matches("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$");
    }
}

```

```md:img [cmd æ§åˆ¶å°]
![](./assets/140.gif)
```

:::

### 2.5.5 çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨

#### 2.5.5.1 æ¦‚è¿°

* åˆ©ç”¨`çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨`ä¹Ÿå¯ä»¥å®ç°æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè¯¥æŠ€æœ¯å¤§é‡ç”¨åœ¨ Java è‡ªå·±çš„æŠ€æœ¯ä¸­ï¼Œå¦‚ï¼šJDBCã€JNDI ç­‰ã€‚

#### 2.5.5.2 å›é¡¾ JDBC çš„ä½¿ç”¨æ­¥éª¤

* â‘  å‡†å¤‡å·¥ä½œï¼š

::: code-group

```shell
# Docker å¯åŠ¨ MySQL 
docker run --name mysql8.0 \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -e MYSQL_DATABASE=test \
  -e TZ=Asia/Shanghai \
  -p 3306:3306 \
  -v /var/mysql8.0/conf:/etc/mysql/conf.d \
  -v /var/mysql8.0/logs:/var/log/mysql \
  -v /var/mysql8.0/data:/var/lib/mysql \
  --restart=always \
  -d mysql:8.0 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_general_ci \
  --lower_case_table_names=1
```

```sql [user.sql]
-- é€‰æ‹©æ•°æ®åº“
use test;
-- åˆ›å»º users è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- æ’å…¥æ¨¡æ‹Ÿæ•°æ®
INSERT INTO users (id, name) VALUES (1, 'Alice');
INSERT INTO users (id, name) VALUES (2, 'Bob');
INSERT INTO users (id, name) VALUES (3, 'Charlie');
INSERT INTO users (id, name) VALUES (4, 'David');
INSERT INTO users (id, name) VALUES (5, 'Eve');
```

```xml [Maven]
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.33</version>
</dependency>
```

:::

* â‘¡ JDBC æ­¥éª¤ï¼š

| æ­¥éª¤                     | æè¿°                               |
| ------------------------ | ---------------------------------- |
| :one: åŠ è½½é©±åŠ¨ï¼ˆéå¿…é¡»ï¼‰ | `Class.forName(...)`               |
| :two: å»ºç«‹è¿æ¥           | `DriverManager.getConnection(...)` |
| :three: é¢„ç¼–è¯‘ SQL       | `connection.prepareStatement(...)` |
| :four: æ‰§è¡ŒæŸ¥è¯¢          | `preparedStatement.executeQuery()` |
| :five: å¤„ç†ç»“æœ          | `while (resultSet.next()) { ... }` |
| :six: å…³é—­èµ„æº           | `try-with-resources` è‡ªåŠ¨å…³é—­      |



* ç¤ºä¾‹ï¼š

```java
package com.github;

import java.sql.*;

public class Test {
    public static void main(String[] args) {

        String url = "jdbc:mysql://localhost:3306/test?serverTimezone=UTC";
        String user = "root";
        String password = "123456";

        String sql = "SELECT * FROM users WHERE id = ?";

        try {
            // 1. åŠ è½½é©±åŠ¨
            // JDBC 4.0+ æ”¯æŒè‡ªåŠ¨åŠ è½½ï¼ˆé€šè¿‡ SPI æœºåˆ¶ï¼‰ï¼Œ
            // ä½†æ˜¾å¼åŠ è½½æ›´å®‰å…¨ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜ã€‚
            Class.forName("com.mysql.cj.jdbc.Driver");

            // 2. å»ºç«‹è¿æ¥
            try (Connection conn = 
                 DriverManager.getConnection(url, user, password);
                 // 3. é¢„ç¼–è¯‘ SQLï¼Œé˜²æ­¢ SQL æ³¨å…¥
                 PreparedStatement pstmt = conn.prepareStatement(sql)) {

                pstmt.setInt(1, 1); // 4. è®¾ç½®å‚æ•°

                // 5. æ‰§è¡ŒæŸ¥è¯¢
                try (ResultSet rs = pstmt.executeQuery()) {
                    // 6. å¤„ç†ç»“æœé›†
                    while (rs.next()) {
                        int id = rs.getInt("id");
                        String name = rs.getString("name");
                        System.out.println("ID: " + id + ", Name: " + name);
                    }
                }
            }
        } catch (ClassNotFoundException e) {
            System.err.println("é©±åŠ¨ç±»æœªæ‰¾åˆ°: " + e.getMessage());
        } catch (SQLException e) {
            System.err.println("æ•°æ®åº“é”™è¯¯: " + e.getMessage());
            e.printStackTrace();
        }

    }
}

```

#### 2.5.5.3 çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨

##### 2.5.5.3.1 æ¦‚è¿°

* JDBC ä¸­ä½¿ç”¨äº† DriverManager æ¥ç®¡ç†é¡¹ç›®ä¸­å¼•å…¥çš„ä¸åŒæ•°æ®åº“é©±åŠ¨ï¼Œå¦‚ï¼šmysql é©±åŠ¨ç­‰ã€‚

![](./assets/141.svg)

* åœ¨ JDK8 ä¸­ï¼ŒDriverManager ç±»ä½äº rt.jar åŒ…ä¸­ï¼Œç”±`å¯åŠ¨ç±»åŠ è½½å™¨`è¿›è¡ŒåŠ è½½ã€‚

![](./assets/142.png)

* ä½†æ˜¯ï¼Œå¯¹äºä¾èµ–ä¸­çš„ mysql é©±åŠ¨å¯¹åº”çš„ç±»ï¼Œåˆ™ç”±`åº”ç”¨ç±»åŠ è½½å™¨`æ¥åŠ è½½ã€‚

![](./assets/143.png)

* è¿™å°±è¿èƒŒäº†åŒäº²å§”æ´¾æœºåˆ¶ï¼ŒåŸå› æ˜¯ï¼šDriverManager å±äº rt.jar æ˜¯ç”±`å¯åŠ¨ç±»åŠ è½½å™¨`è¿›è¡ŒåŠ è½½çš„ï¼›è€Œ mysql ç­‰é©±åŠ¨åˆ™éœ€è¦ç”±`åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`è¿›è¡ŒåŠ è½½ã€‚

> [!NOTE]
>
> * â‘  å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½å®Œ DriverManager åï¼Œéœ€è¦å§”æ‰˜åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå»åŠ è½½ jar åŒ…ä¸­çš„ MySQL é©±åŠ¨ã€‚
> * â‘¡ åœ¨åŒäº²å§”æ´¾æœºåˆ¶ä¸­ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨çš„çº§åˆ«è¦æ¯”åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨é«˜å¾ˆå¤šï¼Œå³ï¼šå‘ä¸Šå§”æ´¾ï¼Œæœ€åè‡ªæ•‘ã€‚
> * â‘¢ ä½†æ˜¯ï¼Œç°åœ¨çš„æµç¨‹å´æ˜¯å’Œ`åŒäº²å§”æ´¾æœºåˆ¶`ç›¸åï¼Œå³ï¼šå¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½å®Œ DriverManager åï¼Œéœ€è¦å§”æ‰˜åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå»åŠ è½½ jar åŒ…ä¸­çš„ MySQL é©±åŠ¨ã€‚

![](./assets/144.svg)

##### 2.5.5.3.2 ç»†èŠ‚ä¸€

* DriverManager ä¹‹æ‰€ä»¥çŸ¥é“ jar åŒ…ä¸­è¦åŠ è½½çš„é©±åŠ¨åœ¨å“ªé‡Œï¼Œä½¿ç”¨äº†å°±æ˜¯ä¸Šæ–‡æåŠåˆ°çš„ SPI æœºåˆ¶ã€‚
* å…¶åŸç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| SPI å·¥ä½œåŸç†         | ç±³çŒ«å”                                                       |
| -------------------- | ------------------------------------------------------------ |
| :one: å®šä¹‰æœåŠ¡æ¥å£   | åˆ›å»ºä¸€ä¸ªæœåŠ¡æ¥å£ã€‚                                           |
| :two: æä¾›å…·ä½“å®ç°   | ä¸åŒçš„å‚å•†æˆ–å¼€å‘è€…æä¾›è¯¥æ¥å£çš„å…·ä½“å®ç°ã€‚                     |
| :three: é…ç½®æ–‡ä»¶å£°æ˜ | åœ¨ `META-INF/services/` ç›®å½•ä¸‹åˆ›å»ºä»¥`æ¥å£å…¨é™å®šå`å‘½åçš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯å®ç°ç±»çš„å…¨é™å®šåã€‚ |
| :four: è¿è¡Œæ—¶å‘ç°    | ä½¿ç”¨ `ServiceLoader` åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å®ç°ç±»ã€‚                |

* JDBC çš„åŸç†ï¼Œå°±æ˜¯è¿™æ ·çš„ï¼š

![](./assets/145.svg)



* ç¤ºä¾‹ï¼šDriverManager çš„æºç åˆ†æ

```java
public class DriverManager {

    static {
        // åˆå§‹åŒ–é˜¶æ®µï¼Œä¼šåŠ è½½é©±åŠ¨
        loadInitialDrivers();
        println("JDBC DriverManager initialized");
    }
    
    // åŠ è½½é©±åŠ¨çš„å…·ä½“å®ç°
    private static void loadInitialDrivers() {
        String drivers;
        try {
            drivers = AccessController.doPrivileged(new PrivilegedAction<String>() {
                public String run() {
                    return System.getProperty("jdbc.drivers");
                }
            });
        } catch (Exception ex) {
            drivers = null;
        }
       

        AccessController.doPrivileged(new PrivilegedAction<Void>() {
            public Void run() {
				// é€šè¿‡ ServiceLoader åŠ è½½ META-INF/Services/java.sql.Driver æ–‡ä»¶
                // å¹¶å°†æ‰€æœ‰çš„é©±åŠ¨ï¼Œå³ï¼šjava.sql.Driver çš„å®ç°ç±»åŠ è½½è¿›æ¥
                ServiceLoader<Driver> loadedDrivers = ServiceLoader.load(Driver.class);
                Iterator<Driver> driversIterator = loadedDrivers.iterator();

               
                try{
                    // å¾ªç¯éå†æ‰€æœ‰é©±åŠ¨ï¼Œæ‹¿åˆ°ç±»åï¼Œå¦‚ï¼šcom.mysql.cj.jdbc.Driver
                    while(driversIterator.hasNext()) {
                        driversIterator.next();
                    }
                } catch(Throwable t) {
                // Do nothing
                }
                return null;
            }
        });

        println("DriverManager.initialize: jdbc.drivers = " + drivers);

        if (drivers == null || drivers.equals("")) {
            return;
        }
        String[] driversList = drivers.split(":");
        println("number of Drivers:" + driversList.length);
        for (String aDriver : driversList) {
            try {
                println("DriverManager.Initialize: loading " + aDriver);
                Class.forName(aDriver, true,
                        ClassLoader.getSystemClassLoader());
            } catch (Exception ex) {
                println("DriverManager.Initialize: load failed: " + ex);
            }
        }
    }
    
    ...
}   
```



* ç¤ºä¾‹ï¼šMySQL é©±åŠ¨æºç åˆ†æä»¥åŠ Debug åˆ†æ

::: code-group

```java [Driver.java]
package com.mysql.cj.jdbc;

import java.sql.DriverManager;
import java.sql.SQLException;
// å®ç°äº† java.sql.Driver  æ¥å£
public class Driver extends NonRegisteringDriver implements java.sql.Driver {
    public Driver() throws SQLException {
    }

    static {
        try {
            // å°†å½“å‰ç±»æ³¨å†Œè¿›å»
            DriverManager.registerDriver(new Driver());
        } catch (SQLException var1) {
            throw new RuntimeException("Can't register driver!");
        }
    }
}
```

```txt [META-INF/services/java.sql.Driver]
com.mysql.cj.jdbc.Driver
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/146.gif)
```

:::

##### 2.5.5.3.3 ç»†èŠ‚äºŒ

* SPI ä½¿ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ä¿å­˜çš„ç±»åŠ è½½å™¨è¿›è¡Œç±»çš„åŠ è½½ï¼Œå¹¶ä¸”è¯¥ç±»åŠ è½½å™¨é€šå¸¸æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚



* ç¤ºä¾‹ï¼šServiceLoader æºç åˆ†æ

```java
public final class ServiceLoader<S>
    implements Iterable<S> {

    public static <S> ServiceLoader<S> load(Class<S> service) {
        // é€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨æ¥è¿›è¡Œç±»çš„åŠ è½½ 
        ClassLoader cl = Thread.currentThread().getContextClassLoader();
        return ServiceLoader.load(service, cl);
    }
    
    ...
}   
```



* ç¤ºä¾‹ï¼šThread æºç åˆ†æ

```java
public class Thread implements Runnable {    
	
    @CallerSensitive
    public ClassLoader getContextClassLoader() {
        if (contextClassLoader == null)
            return null;
        SecurityManager sm = System.getSecurityManager();
        if (sm != null) {
            ClassLoader.checkClassLoaderPermission(contextClassLoader,
                                                   Reflection.getCallerClass());
        }
        return contextClassLoader;
    }
    
    ... 
}
```

##### 2.5.5.3.4 æ€»ç»“

* ä½¿ç”¨`çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨`æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„æ­¥éª¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  * :one: å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ DriverManagerã€‚
  * :two: åœ¨åˆå§‹åŒ– DriverManager çš„æ—¶å€™ï¼Œé€šè¿‡ SPI æœºåˆ¶åŠ è½½ jar åŒ…ä¸­çš„ MySQL é©±åŠ¨ã€‚
  * :three: åœ¨ SPI ä¸­åˆ©ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼ˆåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼‰å»åŠ è½½ç±»å¹¶åˆ›å»ºå¯¹è±¡ã€‚
* å…¶åŠ¨å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

> [!NOTE]
>
> è¿™ç§ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œå§”æ‰˜ç»™åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å»åŠ è½½ç±»çš„æ–¹å¼ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚

![](./assets/147.svg)

### 2.5.6 OSGI æ¡†æ¶çš„ç±»åŠ è½½å™¨

* å†å²ä¸Šï¼ŒOSGI æ¨¡å—åŒ–æ¡†æ¶é€šè¿‡`æ¨¡å—åŒ–`è®¾è®¡å®ç°äº† Java åº”ç”¨ç¨‹åºçš„åŠ¨æ€åŠ è½½å’Œéš”ç¦»ã€‚

> [!NOTE]
>
> * â‘  JDK9 ä¹‹åï¼ŒJava å¹¶æ²¡æœ‰é‡‡ç”¨ OSGI è¿™ç§æ¨¡å—åŒ–æ€æƒ³ï¼Œè€Œæ˜¯é‡‡ç”¨äº† `Java Platform Module Systemï¼ˆJPMSï¼‰`ï¼Œå³ï¼šJigsaw é¡¹ç›®ã€‚
> * â‘¡ å…¶å®ï¼Œå¾ˆå¥½ç†è§£ï¼Œåœ¨ JavaScript æ¨¡å—åŒ–ç³»ç»Ÿå‡ºæ¥ä¹‹å‰ï¼Œå‡ºç°äº† CommonJS ç­‰æ¨¡å—åŒ–æ€æƒ³ï¼›ä½†æ˜¯ï¼Œæœ€ç»ˆ ES Module ç»Ÿä¸€å¤©ä¸‹ã€‚

![](./assets/148.jpg)

* åœ¨ OSGI ä¸­ï¼Œå…è®¸åŒçº§ä¹‹é—´çš„ç±»åŠ è½½è¿›è¡Œå§”æ‰˜åŠ è½½ï¼Œå…¶ä¸­çš„å±‚æ¬¡ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

| OSGI ç±»åŠ è½½å™¨        | æè¿°                                                         |
| -------------------- | ------------------------------------------------------------ |
| :one: çˆ¶ç±»åŠ è½½å™¨     | ç”± Javaå¹³å°ç›´æ¥æä¾›ï¼ŒåŒ…æ‹¬ï¼šå¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ã€æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ã€‚<br>å®ƒä»¬è´Ÿè´£åŠ è½½ä»¥ `java.*` å¼€å¤´çš„ç±»ä»¥åŠåœ¨çˆ¶ç±»å§”æ´¾æ¸…å•ä¸­å£°æ˜ä¸ºè¦å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ã€‚ |
| :two: Bundleç±»åŠ è½½å™¨ | æ¯ä¸ª Bundle éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½æœ¬ Bundle ä¸­çš„ç±»å’Œèµ„æºã€‚<br/>å½“ä¸€ä¸ª Bundle å»è¯·æ±‚åŠ è½½å¦ä¸€ä¸ª Bundle å¯¼å‡ºçš„ Package ä¸­çš„ç±»æ—¶ï¼Œè¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯¼å‡ºç±»çš„é‚£ä¸ª Bundle çš„åŠ è½½å™¨å¤„ç† |
| :three: å…¶å®ƒåŠ è½½å™¨   | çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€æ¡†æ¶ç±»åŠ è½½å™¨ç­‰ã€‚<br>æ¡†æ¶ç±»åŠ è½½å™¨æ˜¯å„ä¸ª OSGi å®ç°æ¡†æ¶è‡ªå·±å®šä¹‰çš„ï¼Œç”¨äºåŠ è½½æ¡†æ¶è‡ªèº«çš„ä»£ç ã€‚<br>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åˆ™ç”¨äºè§£å†³ä¸€äº›ç‰¹å®šçš„åŠ è½½é—®é¢˜ï¼Œå¦‚ï¼šç›´æ¥åŠ è½½æ²¡æœ‰ç»è¿‡å¯¼å…¥å’Œå¯¼å‡ºçš„ç±»ã€‚ |

![](./assets/149.svg)

* OSGi çš„ç±»åŠ è½½å™¨æ”¯æŒåŠ¨æ€åŠ è½½ï¼Œè¿™æ„å‘³ç€ Bundle å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«å®‰è£…ã€å¯åŠ¨ã€åœæ­¢å’Œå¸è½½ã€‚è¿™ç§åŠ¨æ€ç‰¹æ€§ä½¿å¾— OSGi æ¡†æ¶èƒ½å¤Ÿçµæ´»åœ°ç®¡ç†åº”ç”¨ç¨‹åºçš„æ¨¡å—åŒ–ç»“æ„ï¼Œæ”¯æŒçƒ­éƒ¨ç½²å’Œçƒ­æ›´æ–°ã€‚å¦‚ï¼šå½“ä¸€ä¸ª Bundle è¢«å¸è½½æ—¶ï¼Œå…¶ç±»åŠ è½½å™¨ä¹Ÿä¼šè¢«é”€æ¯ï¼Œä»è€Œé‡Šæ”¾ç›¸å…³çš„èµ„æºã€‚

### 2.5.7 çƒ­éƒ¨ç½²

#### 2.5.7.1 æ¦‚è¿°

* çƒ­éƒ¨ç½²æŒ‡çš„å°±æ˜¯åœ¨æœåŠ¡ä¸åœæ­¢çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°æ›´æ–°å­—èŠ‚ç æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚

#### 2.5.7.2 ä½¿ç”¨ arthas ä¸åœæœºè§£å†³çº¿ä¸Šé—®é¢˜

* éœ€æ±‚ï¼šå°æçš„å›¢é˜Ÿå°†ä»£ç ä¸Šçº¿ä¹‹åï¼Œå‘ç°å­˜åœ¨ä¸€ä¸ªå° bug ï¼›ä½†æ˜¯ï¼Œç”¨æˆ·ç€æ€¥ä½¿ç”¨ã€‚å¦‚æœé‡æ–°æ‰“åŒ…å†å‘å¸ƒéœ€è¦ 1 ä¸ªå¤šå°æ—¶ï¼Œå¸Œæœ›èƒ½ä½¿ç”¨ arthas å°½å¿«å°†è¯¥é—®é¢˜ä¿®å¤ã€‚

> [!NOTE]
>
> è§£å†³æ€è·¯ï¼š
>
> * :one: åœ¨å‡ºé—®é¢˜çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½² Arthas ï¼Œå¹¶å¯åŠ¨ã€‚
> * :two: `jad --source-only ç±»çš„å…¨é™å®šå > ç›®å½•/æ–‡ä»¶å.java`ï¼Œç›®çš„æ˜¯ä½¿ç”¨ jad å‘½ä»¤åç¼–è¯‘ä¹‹åå°†æºç ä¿å­˜åˆ°æœåŠ¡å™¨æŸä¸ªç›®å½•ä¸­ï¼Œå†ä½¿ç”¨ vim ç­‰ä¿®æ”¹æºç ã€‚
> * :three: `mc -c ç±»åŠ è½½çš„hashcode ç›®å½•å/æ–‡ä»¶å.java -d è¾“å‡ºç›®å½•`ã€‚ mc æ˜¯ Memory Compiler çš„æ„æ€ï¼Œå³ï¼šå†…å­˜ç¼–è¯‘å™¨ã€‚
> * :four: `retransform classæ–‡ä»¶æ‰€åœ¨ç›®å½•/xxx.class`ï¼Œå³ï¼šä½¿ç”¨ retransform  å‘½ä»¤å°†ç£ç›˜ä¸Šçš„ .class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

> [!CAUTION]
>
> * â‘  ç¨‹åºé‡å¯ä¹‹åï¼Œå­—èŠ‚ç æ–‡ä»¶ä¼šæ¢å¤ï¼Œé™¤éå°† class æ–‡ä»¶æ”¾å…¥åˆ° jar åŒ…ä¸­è¿›è¡Œæ›´æ–°ï¼Œå³ï¼šä¸Šè¿°æ–¹æ¡ˆæ˜¯ä¸´æ—¶æ–¹æ¡ˆã€‚
> * â‘¡ ä½¿ç”¨ retransform ä¸èƒ½æ·»åŠ æ–¹æ³•æˆ–å­—æ®µï¼Œä¹Ÿä¸èƒ½æ›´æ–°æ­£åœ¨æ‰§è¡Œä¸­çš„æ–¹æ³•ã€‚



* ç¤ºä¾‹ï¼šæ­å»ºç¯å¢ƒ

::: code-group

```txt[é¡¹ç›®ç»“æ„]
â”œâ”€ğŸ“ gradle/
â”‚â€ƒâ””â”€ğŸ“ wrapper/
â”‚â€ƒ  â”œâ”€ğŸ“„ gradle-wrapper.jar
â”‚â€ƒ  â””â”€ğŸ“„ gradle-wrapper.properties
â”œâ”€ğŸ“ src/
â”‚â€ƒâ”œâ”€ğŸ“ main/
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ java/
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ com/
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ  â””â”€ğŸ“ github/
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ    â””â”€ğŸ“ lamesphinx/
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â”œâ”€ğŸ“ utils/
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â”‚â€ƒâ””â”€ğŸ“„ UserType.java
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â”œâ”€ğŸ“ web/
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â”‚â€ƒâ””â”€ğŸ“„ UserController.java
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒ      â””â”€ğŸ“„ LameSphinxApplication.java
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ resources/
â”‚â€ƒâ”‚â€ƒ  â”œâ”€ğŸ“ static/
â”‚â€ƒâ”‚â€ƒ  â”œâ”€ğŸ“ templates/
â”‚â€ƒâ”‚â€ƒ  â””â”€ğŸ“„ application.properties
â”‚â€ƒâ””â”€ğŸ“ test/
â”‚â€ƒ  â””â”€ğŸ“ java/
â”‚â€ƒ    â””â”€ğŸ“ com/
â”‚â€ƒ      â””â”€ğŸ“ github/
â”‚â€ƒ        â””â”€ğŸ“ lamesphinx/
â”‚â€ƒ          â””â”€ğŸ“„ LameSphinxApplicationTests.java
â”œâ”€ğŸ“„ .gitattributes
â”œâ”€ğŸ“„ .gitignore
â”œâ”€ğŸ“„ build.gradle
â”œâ”€ğŸ“„ gradlew
â”œâ”€ğŸ“„ gradlew.bat
â””â”€ğŸ“„ settings.gradle
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/150.png)
```

```groovy [build.gradle]
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.5.4'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.github'
version = '0.0.1'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(17)
	}
}

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-web'
	compileOnly 'org.projectlombok:lombok'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
	useJUnitPlatform()
}
```

:::



* ç¤ºä¾‹ï¼šæœ‰ bug çš„ä»£ç 

::: code-group

```java [UserType.java]
package com.github.lamesphinx.utils;

public enum UserType {
    NORMAL(1001,"æ™®é€šç”¨æˆ·"),
    VIP(1002,"VIP ç”¨æˆ·");

    private final Integer type;

    private final String desc;

    UserType(Integer type, String desc) {
        this.type = type;
        this.desc = desc;
    }

    public Integer getType() {
        return type;
    }

    public String getDesc() {
        return desc;
    }
}
```

``` java [UserController.java]
package com.github.lamesphinx.web;

import com.github.lamesphinx.utils.UserType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/user")
public class UserController {

    @GetMapping("/{type}/{id}")
    public ResponseEntity<String> user(
            @PathVariable("type") Integer type,
            @PathVariable("id") Integer id) {
        // è¿™è¾¹æœ‰ bug
        if (type == UserType.NORMAL.getType()) {
            return ResponseEntity
                    .ok()
                    .body(String.format("æ™®é€šç”¨æˆ·æ— æƒé™æŸ¥çœ‹ ==> %s", id));
        }
        return ResponseEntity
                .ok()
                .body((String.format("åªæœ‰å°Šè´µçš„ VIP ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ ==> %s", id)));
    }

}
```

```java [LameSphinxApplication.java]
package com.github.lamesphinx;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class LameSphinxApplication {

	public static void main(String[] args) {
		SpringApplication.run(LameSphinxApplication.class, args);
	}

}
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/151.gif)
```

:::



* ç¤ºä¾‹ï¼šå¯åŠ¨ Arthas ã€åç¼–è¯‘æºç ä»¥åŠä¿®æ”¹é€»è¾‘

::: code-group

```bash
# å¯åŠ¨ Arthas 
java -jar arthas-boot.jar
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/152.gif)
```

```bash
# åç¼–è¯‘æºç åˆ°æŒ‡å®šæ–‡ä»¶
jad --source-only com.github.lamesphinx.web.UserController > /tmp/UserController.java
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/153.gif)
```

```bash
# ä¿®æ”¹é€»è¾‘
vim /tmp/UserController.java
```

```md:img [cmdæ§åˆ¶å°]
![](./assets/154.gif)
```

:::



* ç¤ºä¾‹ï¼šç¼–è¯‘ Java æºä»£ç ã€å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜

::: code-group

```bash
# æŸ¥è¯¢åŠ è½½ç±»çš„ç±»åŠ è½½å™¨çš„ hash
sc -d com.github.lamesphinx.web.UserController
```

```md:img [cmdæ§åˆ¶å°]
![](./assets/155.gif)
```

```bash
# ä½¿ç”¨ä¸“é—¨çš„ç±»åŠ è½½å™¨å†…å­˜ç¼–è¯‘ Java æºä»£ç 
mc -c 65b3120a /tmp/UserController.java -d /tmp
```

```md:img [cmdæ§åˆ¶å°]
![](./assets/156.gif)
```

```bash
# å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­
retransform /tmp/com/github/lamesphinx/web/UserController.class
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/157.gif)
```

:::



* ç¤ºä¾‹ï¼šæµ‹è¯•

::: code-group

```bash
curl http://localhost:8080/user/1001/1
```

```md:img [cmd æ§åˆ¶å°]
![](./assets/158.gif)
```

:::

## 2.6 JDK9 ä¹‹åçš„ç±»åŠ è½½å™¨

### 2.6.1 JDK8 ä¹‹å‰çš„ç±»åŠ è½½å™¨

* JDK8 ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œ`æ‰©å±•ç±»åŠ è½½å™¨`å’Œ`åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`çš„æºç ä½äº`rt.jar`åŒ…ä¸­çš„`sun.misc.Launcher.java`ä¸­ã€‚

![](./assets/159.svg)

### 2.6.2 JDK9 ä¹‹åçš„ç±»åŠ è½½å™¨

* JDK9 å¼•å…¥äº† module çš„æ¦‚å¿µï¼Œä¸å†ä½¿ç”¨ jar åŒ…æ¥ç®¡ç†ç±»ï¼Œè€Œæ˜¯ä½¿ç”¨ jmods æ¥ç®¡ç†ç±»ã€‚

![](./assets/160.png)

* ç±»åŠ è½½å™¨åœ¨è®¾è®¡ä¸Šä¹Ÿå‘ç”Ÿäº†å¾ˆå¤šå˜åŒ–ï¼šå¯åŠ¨ç±»åŠ è½½å™¨ä½¿ç”¨ Java ç¼–å†™ã€‚

> [!NOTE]
>
> * â‘  `å¯åŠ¨ç±»åŠ è½½å™¨`ä½äº jdk.internal.loader.ClassLoaders ç±»ä¸­
> * â‘¡ Java ä¸­çš„ BootClassLoader ç»§æ‰¿è‡ª BuiltinClassLoader ï¼Œå®ç°ä»æ¨¡å—ä¸­æ‰¾åˆ°è¦åŠ è½½çš„å­—èŠ‚ç èµ„æºæ–‡ä»¶ã€‚
> * â‘¢ `å¯åŠ¨ç±»åŠ è½½å™¨ä¾ç„¶æ— æ³•é€šè¿‡ Java ä»£ç è·å–åˆ°ï¼Œè¿”å›çš„ä¾ç„¶æ˜¯ nullï¼Œä¿æŒäº†ç»Ÿä¸€`ã€‚

![](./assets/161.svg)

* ç±»åŠ è½½å™¨åœ¨è®¾è®¡ä¸Šä¹Ÿå‘ç”Ÿäº†å¾ˆå¤šå˜åŒ–ï¼šæ‰©å±•ç±»åŠ è½½å™¨å˜æˆäº†å¹³å°ç±»åŠ è½½å™¨ã€‚

> [!NOTE]
>
> * â‘  `å¹³å°ç±»åŠ è½½å™¨`ä½äº jdk.internal.loader.ClassLoaders ç±»ä¸­
> * â‘¡ Java ä¸­çš„ PlatformClassLoader ç»§æ‰¿è‡ª BuiltinClassLoader ï¼Œå®ç°ä»æ¨¡å—ä¸­æ‰¾åˆ°è¦åŠ è½½çš„å­—èŠ‚ç èµ„æºæ–‡ä»¶ã€‚
> * â‘¢ `å¹³å°ç±»åŠ è½½å™¨çš„å­˜æ”¾æ›´å¤šçš„æ˜¯ä¸ºäº†å’Œè€ç‰ˆæœ¬çš„è®¾è®¡å…¼å®¹ï¼Œè‡ªèº«æ²¡æœ‰ç‰¹æ®Šçš„é€»è¾‘`ã€‚

![](./assets/162.svg)

* ç±»åŠ è½½å™¨åœ¨è®¾è®¡ä¸Šä¹Ÿå‘ç”Ÿäº†å¾ˆå¤šå˜åŒ–ï¼šåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨é€»è¾‘è¿˜æ˜¯ä¸€æ ·ï¼Œç»§æ‰¿å‘ç”Ÿäº†å˜åŒ–ã€‚

> [!NOTE]
>
> * â‘  `åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`ä½äº jdk.internal.loader.ClassLoaders ç±»ä¸­
> * â‘¡ Java ä¸­çš„ AppClassLoader ç»§æ‰¿è‡ª BuiltinClassLoader ï¼Œå®ç°ä»æ¨¡å—ä¸­æ‰¾åˆ°è¦åŠ è½½çš„å­—èŠ‚ç èµ„æºæ–‡ä»¶ã€‚

![](./assets/163.svg)
